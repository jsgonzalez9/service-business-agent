module.exports=[77775,e=>{"use strict";var t=e.i(47909),n=e.i(74017),a=e.i(96250),o=e.i(59756),s=e.i(61916),i=e.i(14444),r=e.i(37092),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),p=e.i(47587),m=e.i(66012),_=e.i(70101),g=e.i(26937),h=e.i(10372),w=e.i(93695);e.i(52474);var f=e.i(5232),R=e.i(89171),v=e.i(54233),y=e.i(66893),x=e.i(32721),b=e.i(76296),S=e.i(84359),C=e.i(89660),T=e.i(84204);e.i(89228);var E=e.i(91601),A=e.i(55156);function I(e){return Math.sqrt(e.reduce((e,t)=>e+t*t,0))}async function M(e){let t=new E.default({apiKey:process.env.OPENAI_API_KEY});return(await t.embeddings.create({model:"text-embedding-3-small",input:e})).data[0].embedding}async function N(e,t,n,a=.85,o){let s=(0,A.createServiceClient)(),i=await M(t),r=s.from("cached_responses").select("id,response_text,embedding,intent,market,usage_count,created_at").eq("intent",e);n&&(r=r.eq("market",n));let{data:l}=await r.limit(200),d=Date.now(),c="number"==typeof o&&o>0?24*o*36e5:void 0,u=(l||[]).filter(e=>!c||d-new Date(e.created_at).getTime()<=c).map(e=>{var t;let n,a;return{id:e.id,text:e.response_text,score:(t=e.embedding||[],n=I(i),a=I(t),n&&a?function(e,t){let n=0;for(let a=0;a<Math.min(e.length,t.length);a++)n+=e[a]*t[a];return n}(i,t)/(n*a):0)}});u.sort((e,t)=>t.score-e.score);let p=u[0];if(p&&p.score>=a){let e=(l||[]).find(e=>e.id===p.id);return await s.from("cached_responses").update({usage_count:(e?.usage_count||0)+1,last_used_at:new Date().toISOString()}).eq("id",p.id),{text:p.text,confidence:p.score,id:p.id}}return{text:null,confidence:0}}var O=e.i(56542);async function k(e){try{let t,n,a=await e.formData(),o=a.get("From"),s=a.get("Body"),i=a.get("MessageSid");if(console.log(`[Incoming SMS] From: ${o}, Message: ${s}`),!o||!s)return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});let r=await (0,v.getLeadByPhone)(o);if(!r)return console.log(`No lead found for phone: ${o}`),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});if("contract_signed"===r.conversation_state||"closed"===r.conversation_state)return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});await (0,v.saveMessage)({lead_id:r.id,direction:"inbound",content:s,twilio_sid:i});let l=s.trim().toLowerCase(),d="stop"===l||l.includes("unsubscribe")||l.includes("cancel")||"end"===l||"quit"===l||l.includes("stop all")||l.includes("do not text"),c="start"===l||"yes"===l||"y"===l||l.includes("unstop")||l.includes("subscribe");if(d){await (0,v.updateLead)(r.id,{is_opted_out:!0,opted_out_at:new Date().toISOString(),optout_reason:"keyword"}),await (0,v.saveMessage)({lead_id:r.id,direction:"outbound",content:"You’ve been unsubscribed — no more messages."});let{error:e}=await (0,x.sendSMS)(r.phone_number,"You’ve been unsubscribed — no more messages.",{withFooter:!1,bypassSuppression:!0});try{let e=await (0,C.createClient)();await e.from("consents").insert({lead_id:r.id,phone_number:r.phone_number,event:"opt_out",source:"keyword",message_sid:i})}catch{}return e&&console.error("Failed to send opt-out confirmation:",e),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}if(c){await (0,v.updateLead)(r.id,{is_opted_out:!1,optout_reason:null,consent_status:"opt_in",consented_at:new Date().toISOString(),consent_source:"keyword"});try{let e=await (0,C.createClient)();await e.from("consents").insert({lead_id:r.id,phone_number:r.phone_number,event:"opt_in",source:"keyword",message_sid:i})}catch{}return await (0,v.saveMessage)({lead_id:r.id,direction:"outbound",content:"Thanks for confirming — we’ll text you about your property. Reply STOP to unsubscribe."}),await (0,x.sendSMS)(r.phone_number,"Thanks for confirming — we'll text you about your property. Reply STOP to unsubscribe.",{withFooter:!1,bypassSuppression:!0}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}if("help"===l||l.includes("help"))return await (0,v.saveMessage)({lead_id:r.id,direction:"outbound",content:"Help: We send messages about property offers. Msg&Data rates may apply. Reply STOP to unsubscribe. For support, reply here."}),await (0,x.sendSMS)(r.phone_number,"Help: We send messages about property offers. Reply STOP to unsubscribe.",{withFooter:!1,bypassSuppression:!0}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});if(["not interested","stop contacting me","wrong number","nla","remove me","sold already","do not contact","no longer available","not selling","leave me alone"].some(e=>l.includes(e)))return await (0,v.updateLead)(r.id,{pipeline_status:"DEAD",score:0,tags:Array.from(new Set([...r.tags||[],"dead"]))}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});("cold_lead"===r.conversation_state||"contacted"===r.conversation_state)&&(await (0,v.updateLead)(r.id,{conversation_state:"contacted"}),r.conversation_state="contacted");let u=await (0,y.getAgentConfig)(),p=(0,T.classifyIntent)(s),m=null;if(!1!==u.llm_cache_enabled&&p.startsWith("FAQ")){let e=(0,T.normalizeQuestion)(s),{text:t,confidence:n}=await (0,T.lookupCached)(p,e);if(t&&n>=.85)m=t;else{let e="number"==typeof u.llm_cache_confidence_floor?u.llm_cache_confidence_floor:.85,t=p.startsWith("FAQ")?u.llm_cache_ttl_faq_days??30:u.llm_cache_ttl_objection_days??14,n=r.state||void 0,a=u.llm_cache_market_overrides||{};n&&a[n]&&(e=a[n].confidence_floor??e,t=p.startsWith("FAQ")?a[n].ttl_faq_days??t:a[n].ttl_objection_days??t);let o=await N(p,s,n,e,t);o.text&&o.confidence>=.85&&(m=o.text)}}let _=m?{message:m,modelUsed:null,escalated:!1,updatedLead:{},newState:null,callIntent:null}:await (0,y.generateAgentResponse)(r,s,u);console.log(`[AI Response] Model: ${_.modelUsed}, Escalated: ${_.escalated}`),Object.keys(_.updatedLead).length>0&&await (0,v.updateLead)(r.id,_.updatedLead);let g=(t=s.toLowerCase(),n=new Set,(t.includes("vacant")||t.includes("no one living")||t.includes("empty"))&&n.add("vacant"),(t.includes("absentee")||t.includes("out of state")||t.includes("live elsewhere"))&&n.add("absentee"),(t.includes("preforeclosure")||t.includes("behind on payments")||t.includes("foreclosure"))&&n.add("preforeclosure"),(t.includes("tenant issues")||t.includes("late rent")||t.includes("landlord")||t.includes("tired landlord"))&&n.add("tired landlord"),Array.from(n));if(g.length>0&&await (0,v.updateLead)(r.id,{tags:Array.from(new Set([...r.tags||[],...g]))}),_.newState&&await (0,v.updateLead)(r.id,{conversation_state:_.newState}),_.callIntent?.action==="update_lead_status"&&_.callIntent?.lead_status){if(console.log(`[Call Intent Detected] Lead: ${r.id}, Status: ${_.callIntent.lead_status}, Time: ${_.callIntent.call_time||"immediate"}`),await (0,v.updateLead)(r.id,{conversation_state:_.callIntent.lead_status}),"booked"===_.callIntent.lead_status)await (0,O.createBooking)(r.id,_.callIntent.call_time||"Unknown Time","AI Booking via SMS"),console.log(`[Booking Confirmed] Lead: ${r.id}, Time: ${_.callIntent.call_time}`);else if("text_only"!==_.callIntent.lead_status)try{await (0,b.triggerVoiceCall)(r.id,_.callIntent.lead_status,_.callIntent.call_time),console.log(`[Voice Call Triggered] for lead: ${r.id}`)}catch(e){console.error(`[Voice Call Error] Failed to trigger call for lead ${r.id}:`,e)}}let h=new Set(["offer_made","offer_accepted","contract_sent","ready_for_offer_call","warm_call_requested","schedule_call","booked"]);if((_.escalated||_.newState&&h.has(_.newState)||_.callIntent?.lead_status&&h.has(_.callIntent.lead_status))&&(await (0,v.updateLead)(r.id,{pipeline_status:"HOT",score:5}),await (0,S.notifyHotLead)({id:r.id,name:r.name,phone_number:r.phone_number,address:r.address})),!m&&p.startsWith("FAQ")){let e=(0,T.normalizeQuestion)(s);await (0,T.storeCached)(p,e,_.message)}let{sid:w,error:f}=await (0,x.sendSMS)(o,_.message);f&&console.error("Failed to send SMS:",f),await (0,v.saveMessage)({lead_id:r.id,direction:"outbound",content:_.message,twilio_sid:w||void 0,model_used:m?null:_.modelUsed,was_escalated:_.escalated});try{let e=await (0,C.createClient)();await e.from("message_metrics").insert({lead_id:r.id,model:_.modelUsed||null,tokens:null,cost:null,confidence:m?1:.75})}catch{}return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}catch(e){return console.error("Error processing incoming SMS:",e),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}}e.s(["POST",()=>k],93340);var P=e.i(93340);let F=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/twilio/incoming/route",pathname:"/api/twilio/incoming",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/twilio/incoming/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:U,workUnitAsyncStorage:D,serverHooks:L}=F;function q(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:D})}async function H(e,t,a){F.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/twilio/incoming/route";R=R.replace(/\/index$/,"")||"/";let v=await F.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:x,nextConfig:b,parsedUrl:S,isDraftMode:C,prerenderManifest:T,routerServerContext:E,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,resolvedPathname:M,clientReferenceManifest:N,serverActionsManifest:O}=v,k=(0,l.normalizeAppPath)(R),P=!!(T.dynamicRoutes[k]||T.routes[M]),U=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,S,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!T.routes[M],t=T.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await U();throw new w.NoFallbackError}}let D=null;!P||F.isDev||C||(D="/index"===(D=M)?"/":D);let L=!0===F.isDev||!P,q=P&&!L;O&&N&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:N,serverActionsManifest:O,serverModuleMap:(0,r.createServerModuleMap)({serverActionsManifest:O})});let H=e.method||"GET",$=(0,s.getTracer)(),j=$.getActiveScopeSpan(),B={params:x,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>F.onRequestError(e,t,a,E)},sharedContext:{buildId:y}},K=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),Q=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>F.handle(Q,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=$.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),r=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let d=async({previousCacheEntry:n})=>{try{if(!r&&A&&I&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(K,W,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await F.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},E),t}},c=await F.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:r});if(!P)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});r||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,_.fromNodeOutgoingHttpHeaders)(c.value.headers);return r&&P||u.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(K,W,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};j?await l(j):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await F.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})}),P)throw t;return await (0,m.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>q,"routeModule",()=>F,"serverHooks",()=>L,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>D],77775)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e8e8960f.js.map