{"version":3,"sources":["../../../lib/supabase/server.ts","../../../lib/twilio.ts","../../../node_modules/.pnpm/next%4016.0.7_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.ts","../../../node_modules/.pnpm/next%4016.0.7_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../node_modules/.pnpm/next%4016.0.7_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../lib/supabase/service.ts","../../../lib/wholesaling-agent.ts","../../../lib/voice-call-actions.ts","../../../lib/cache-router.ts","../../../lib/faq/default.ts","../../../lib/notify.ts","../../../lib/llm-cache.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Server Component - ignore\n        }\n      },\n    },\n  })\n}\n","import twilio from \"twilio\"\nimport { createClient } from \"@/lib/supabase/server\"\n\nconst accountSid = process.env.TWILIO_ACCOUNT_SID\nconst authToken = process.env.TWILIO_AUTH_TOKEN\nconst twilioPhoneNumber = process.env.TWILIO_PHONE_NUMBER\nconst twilioCallerId = process.env.TWILIO_CALLER_ID\nconst twilioNumberPool = (process.env.TWILIO_NUMBER_POOL || \"\")\n  .split(\",\")\n  .map((s) => s.trim())\n  .filter((s) => s.length > 0)\nconst monthlyLimitPerNumber = Number(process.env.SMS_MONTHLY_LIMIT_PER_NUMBER || 10000)\n\nfunction monthStartISO(): string {\n  const d = new Date()\n  d.setDate(1)\n  d.setHours(0, 0, 0, 0)\n  return d.toISOString()\n}\n\nasync function chooseFromNumber(): Promise<string | null> {\n  const pool = twilioNumberPool.length > 0 ? twilioNumberPool : (twilioPhoneNumber ? [twilioPhoneNumber] : [])\n  if (pool.length === 0) return null\n\n  try {\n    const supabase = await createClient()\n    const { data } = await supabase\n      .from(\"call_events\")\n      .select(\"event_data, created_at\")\n      .eq(\"event_type\", \"sms_sent\")\n      .gte(\"created_at\", monthStartISO())\n\n    const counts: Record<string, number> = {}\n    for (const row of data || []) {\n      const from = (row as any).event_data?.from\n      if (typeof from === \"string\") counts[from] = (counts[from] || 0) + 1\n    }\n\n    const eligible = pool.filter((num) => (counts[num] || 0) < monthlyLimitPerNumber)\n    if (eligible.length === 0) return null\n\n    let selected = eligible[0]\n    let min = counts[selected] || 0\n    for (const num of eligible) {\n      const c = counts[num] || 0\n      if (c < min) {\n        min = c\n        selected = num\n      }\n    }\n    return selected\n  } catch {\n    return pool[0]\n  }\n}\n\nexport async function eligibleNumbersSorted(): Promise<string[]> {\n  const pool = twilioNumberPool.length > 0 ? twilioNumberPool : (twilioPhoneNumber ? [twilioPhoneNumber] : [])\n  if (pool.length === 0) return []\n  try {\n    const supabase = await createClient()\n    const { data } = await supabase\n      .from(\"call_events\")\n      .select(\"event_data, created_at\")\n      .eq(\"event_type\", \"sms_sent\")\n      .gte(\"created_at\", monthStartISO())\n    const counts: Record<string, number> = {}\n    for (const row of data || []) {\n      const from = (row as any).event_data?.from\n      if (typeof from === \"string\") counts[from] = (counts[from] || 0) + 1\n    }\n    const eligible = pool.filter((num) => (counts[num] || 0) < monthlyLimitPerNumber)\n    return eligible.sort((a, b) => (counts[a] || 0) - (counts[b] || 0))\n  } catch {\n    return pool\n  }\n}\n\n// Create Twilio client (only if credentials are available)\nexport function getTwilioClient() {\n  if (!accountSid || !authToken) {\n    console.warn(\"Twilio credentials not configured\")\n    return null\n  }\n  return twilio(accountSid, authToken)\n}\n\nexport function chooseCallerId(): string | null {\n  if (twilioCallerId && twilioCallerId.length > 0) return twilioCallerId\n  const pool = twilioNumberPool.length > 0 ? twilioNumberPool : (twilioPhoneNumber ? [twilioPhoneNumber] : [])\n  return pool.length > 0 ? pool[0] : null\n}\n\nexport async function sendSMS(\n  to: string,\n  body: string,\n  opts?: { withFooter?: boolean; bypassSuppression?: boolean },\n): Promise<{ sid: string | null; error: string | null }> {\n  const client = getTwilioClient()\n\n  if (!client) {\n    const footer = (opts?.withFooter ?? true) ? \"\\n\\nReply STOP to unsubscribe\" : \"\"\n    const fullBody = `${body}${footer}`\n    console.log(`[MOCK SMS] To: ${to}\\nMessage: ${fullBody}`)\n    return { sid: `mock_${Date.now()}`, error: null }\n  }\n\n  // Quiet hours block\n  const quietStart = Number(process.env.SMS_QUIET_HOURS_START || 8)\n  const quietEnd = Number(process.env.SMS_QUIET_HOURS_END || 21)\n  const nowHour = new Date().getHours()\n  if (nowHour < quietStart || nowHour >= quietEnd) {\n    return { sid: null, error: \"Quiet hours active; message not sent\" }\n  }\n\n  // Suppression check by phone opt-out\n  if (!opts?.bypassSuppression) {\n    try {\n      const supabase = await createClient()\n      let normalized = to.replace(/\\D/g, \"\")\n      if (normalized.length === 10) normalized = `+1${normalized}`\n      else if (normalized.length === 11 && normalized.startsWith(\"1\")) normalized = `+${normalized}`\n      else if (!normalized.startsWith(\"+\")) normalized = `+${normalized}`\n      const { data: lead } = await supabase.from(\"leads\").select(\"*\").eq(\"phone_number\", normalized).single()\n      if (lead && (lead as any).is_opted_out) {\n        return { sid: null, error: \"Recipient has opted out\" }\n      }\n    } catch {}\n  }\n\n  const candidates = await eligibleNumbersSorted()\n  if (candidates.length === 0) {\n    return { sid: null, error: \"No available Twilio sender number (check pool or config)\" }\n  }\n\n  try {\n    // Simple per-minute rate limit using recent sms_events\n    try {\n      const supabase = await createClient()\n      const since = new Date(Date.now() - 60_000).toISOString()\n      const { count } = await supabase\n        .from(\"sms_events\")\n        .select(\"id\", { count: \"exact\", head: true })\n        .gte(\"created_at\", since)\n      const limit = Number(process.env.SMS_RATE_LIMIT_PER_MIN || 25)\n      if ((count || 0) >= limit) {\n        return { sid: null, error: \"Rate limit exceeded, try later\" }\n      }\n    } catch {}\n    const footerParts: string[] = []\n    try {\n      const supabase = await createClient()\n      const { data: cfg } = await supabase.from(\"agent_config\").select(\"*\").limit(1).single()\n      const company = (cfg as any)?.company_name || \"Your Company\"\n      footerParts.push(`${company}: real estate lead generation`)\n    } catch {\n      footerParts.push(\"Real estate lead generation\")\n    }\n    footerParts.push(\"Msg & data rates may apply\")\n    footerParts.push(\"Reply HELP for help\")\n    footerParts.push(\"Reply STOP to unsubscribe\")\n    const footerText = footerParts.join(\" â€¢ \")\n    const footer = (opts?.withFooter ?? true) ? `\\n\\n${footerText}` : \"\"\n    const fullBody = `${body}${footer}`\n    const statusCallback = `${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/api/twilio/status`\n\n    let lastError: string | null = null\n    for (const fromNumber of candidates) {\n      try {\n        const message = await client.messages.create({\n          body: fullBody,\n          from: fromNumber,\n          to,\n          statusCallback,\n        })\n        try {\n          const supabase = await createClient()\n          await supabase.from(\"sms_events\").insert({\n            sid: message.sid,\n            to_number: to,\n            from_number: fromNumber,\n            status: \"sent\",\n            error: null,\n            body,\n          })\n        } catch {}\n        return { sid: message.sid, error: null }\n      } catch (e: any) {\n        lastError = e?.message ? String(e.message) : \"Failed to send SMS\"\n        continue\n      }\n    }\n    try {\n      const supabase = await createClient()\n      await supabase.from(\"sms_events\").insert({\n        sid: null,\n        to_number: to,\n        from_number: candidates[0],\n        status: \"failed\",\n        error: lastError || \"Failed to send SMS\",\n        body,\n      })\n    } catch {}\n    return { sid: null, error: lastError || \"Failed to send SMS\" }\n  } catch (error) {\n    console.error(\"Error sending SMS:\", error)\n    return { sid: null, error: error instanceof Error ? error.message : \"Failed to send SMS\" }\n  }\n}\n\nexport function validateTwilioRequest(signature: string, url: string, params: Record<string, string>): boolean {\n  if (!authToken) {\n    // Skip validation in development without credentials\n    return true\n  }\n\n  return twilio.validateRequest(authToken, signature, url, params)\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.ReactServerDOMTurbopackServer\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import { createClient } from \"@supabase/supabase-js\"\n\nexport function createServiceClient() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY!\n  return createClient(url, key)\n}\n\n","import { createClient } from \"@/lib/supabase/server\"\nimport type { Lead, Message, AgentConfig, CallIntentAction } from \"@/lib/types\"\nimport OpenAI from \"openai\"\n\nconst NODE_A_SYSTEM_PROMPT = `You are the Lead Outreach Agent for a real estate wholesaling company. \nYour goal is to qualify leads via SMS: gather property condition, motivation, timeline, and price expectations. \nYou are friendly, polite, and professional. \nDo not handle complex negotiation; if the lead expresses a strong objection or is ready to sign, flag it for escalation to the advanced agent.\n\nOUTPUT: SMS text messages only. Each response should be 1-2 short text messages max.\n\nQUALIFICATION QUESTIONS (ask subtly):\n- \"Can you tell me about the property condition?\"\n- \"What's your ideal timeline to sell?\"\n- \"Do you have a price in mind?\"\n\nIMPORTANT:\n- Always write in short SMS-friendly messages\n- Do not make phone calls\n- Track conversation status\n- Flag complex objections or agreement signals for escalation\n\n---\n\n# ðŸ“Œ **CALL INTENT DETECTION LOGIC**\n\n**Your job is to determine whether a seller is asking for a phone call or would benefit from an immediate call.\nWhen you detect call intent, you MUST return the appropriate call intent JSON.**\n\n## **TRIGGER A CALL WHEN ANY OF THE FOLLOWING ARE TRUE:**\n\n### **1. Direct Call Requests**\nIf the seller writes: \"call me\", \"can you call me?\", \"you can call now\", \"call anytime\", \"here's my number\", \"call later\", \"call tomorrow\", \"call after 5\", \"just call\", \"give me a call\", \"we can talk on the phone\", \"call instead\"\n\nReturn:\n{\n  \"action\": \"update_lead_status\",\n  \"lead_status\": \"warm_call_requested\"\n}\n\nIf a time is mentioned (e.g., \"call after 5\"):\n{\n  \"action\": \"update_lead_status\",\n  \"lead_status\": \"schedule_call\",\n  \"call_time\": \"SELLER PROVIDED TIME\"\n}\n\n### **2. Indirect Call Intent**\nIf the seller hints at wanting a more detailed conversation: \"I want to talk about this\", \"we can discuss it\", \"let's talk\", \"can you explain how this works?\", \"I have questions\", \"I want to hear the offer\", \"can you walk me through it\"\n\nReturn:\n{\n  \"action\": \"update_lead_status\",\n  \"lead_status\": \"warm_call_requested\"\n}\n\n### **3. Strategic Call Situations**\nEven if not explicitly requested, trigger a call if:\n- They are price curious: \"what can you offer me?\"\n- They say: \"depends on the price\"\n- They say: \"I'd consider selling\"\n- They are confused or hesitant but open\n- They want details about closing process or timeline info\n- They stop responding to text after showing interest\n\nReturn:\n{\n  \"action\": \"update_lead_status\",\n  \"lead_status\": \"ready_for_offer_call\"\n}\n\n### **4. Do Not Call Signal**\nIf they say: \"don't call\", \"text only\", \"I can't talk on the phone\", \"don't call this number\"\n\nReturn:\n{\n  \"action\": \"update_lead_status\",\n  \"lead_status\": \"text_only\"\n}\n\n## **RESPONSE FORMAT**\n\nAlways include this JSON at the END of your response:\n\nIf call intent detected:\n{\n  \"callIntent\": {\n    \"action\": \"update_lead_status\",\n    \"lead_status\": \"warm_call_requested|schedule_call|ready_for_offer_call|text_only\",\n    \"call_time\": \"OPTIONAL - time if seller specified\"\n  }\n}\n\nIf no call intent:\n{\n  \"callIntent\": {\n    \"action\": \"none\"\n  }\n}`\n\nconst NODE_B_SYSTEM_PROMPT = `You are the Advanced Negotiation & Closing Agent for a real estate wholesaling company.\nYour goal is to handle complex seller objections, finalize offers, and generate contract-ready messages.\nYou can reason through multi-step negotiation, suggest counteroffers, and format DocuSign contract messages.\nAlways maintain a professional, polite tone.\n\nCAPABILITIES:\n- Handle complex price objections with reasoning\n- Negotiate counteroffers professionally\n- Finalize deal terms and prepare contract messaging\n- Generate DocuSign-ready instructions\n\nOFFER CALCULATION:\n- MAO = (ARV Ã— 0.7) â€“ Repairs â€“ Fee\n- Present offers politely with justification\n\nCONTRACT PREPARATION:\n- When lead agrees: prepare contract with Name, Address, Offer Amount, Closing Date\n- Send link: \"Great! I've prepared the contract for [Property Address]. You can review and sign here: [Link]\"\n\nOBJECTION HANDLING:\n- Price too low â†’ Explain value, ask for their target price, consider counteroffer\n- Timeline concerns â†’ \"We can close as fast as you need, usually within 7-14 days\"\n- Trust issues â†’ Provide company credentials, offer references\n\nOUTPUT: SMS text messages only. Keep responses professional but concise.`\n\nconst ESCALATION_KEYWORDS = [\n  \"agree\",\n  \"accept\",\n  \"deal\",\n  \"ready to sell\",\n  \"let's do it\",\n  \"sounds good\",\n  \"too low\",\n  \"not enough\",\n  \"more money\",\n  \"higher\",\n  \"counteroffer\",\n  \"counter offer\",\n  \"my price\",\n  \"i want\",\n  \"need at least\",\n  \"won't accept\",\n  \"can't accept\",\n  \"final offer\",\n  \"best offer\",\n  \"walk away\",\n  \"not interested anymore\",\n  \"lawyer\",\n  \"attorney\",\n  \"legal\",\n  \"contract terms\",\n  \"contingency\",\n]\n\nfunction shouldEscalateToNodeB(message: string, conversationState: string): boolean {\n  const lowerMessage = message.toLowerCase()\n\n  // Always escalate if in offer_made or later states\n  if ([\"offer_made\", \"contract_sent\", \"offer_accepted\"].includes(conversationState)) {\n    return true\n  }\n\n  // Check for escalation keywords\n  for (const keyword of ESCALATION_KEYWORDS) {\n    if (lowerMessage.includes(keyword)) {\n      return true\n    }\n  }\n\n  // Check for price mentions with disagreement signals\n  const pricePattern = /\\$[\\d,]+|\\d+k|\\d+\\s*(thousand|k)/i\n  const disagreementSignals = [\"but\", \"however\", \"actually\", \"really\", \"honestly\", \"no\", \"not\"]\n\n  if (pricePattern.test(lowerMessage)) {\n    for (const signal of disagreementSignals) {\n      if (lowerMessage.includes(signal)) {\n        return true\n      }\n    }\n  }\n\n  return false\n}\n\nexport interface AgentResponse {\n  message: string\n  updatedLead: Partial<Lead>\n  newState?: Lead[\"conversation_state\"]\n  modelUsed: \"gpt-5.1\"\n  escalated: boolean\n  callIntent?: CallIntentAction\n}\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })\n\nasync function callOpenAI(systemPrompt: string, userPrompt: string): Promise<{ text: string; usage?: any }> {\n  const response = await openai.chat.completions.create({\n    model: \"gpt-5.1\",\n    max_tokens: 800,\n    temperature: 0.7,\n    messages: [\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: userPrompt },\n    ],\n  })\n  const text = response.choices[0]?.message?.content || \"\"\n  return { text, usage: response.usage }\n}\n\nexport async function getAgentConfig(): Promise<AgentConfig> {\n  const supabase = await createClient()\n  const { data, error } = await supabase.from(\"agent_config\").select(\"*\").single()\n\n  if (error || !data) {\n    // Return defaults if no config exists\n    return {\n      id: \"\",\n      company_name: \"CashBuyer Properties\",\n      wholesaling_fee: 10000,\n      arv_multiplier: 0.7,\n      follow_up_hours: 24,\n      max_follow_ups: 3,\n      followup_backoff_minutes: 15,\n      followup_max_attempts: 3,\n      llm_cache_enabled: true,\n      llm_cache_confidence_floor: 0.85,\n      llm_cache_ttl_faq_days: 30,\n      llm_cache_ttl_objection_days: 14,\n      auto_dispo_eval_enabled: true,\n      auto_renegotiate_days_threshold: 5,\n      auto_cancel_days_threshold: 10,\n      auto_dispo_require_human_confirm: true,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    }\n  }\n\n  return data as AgentConfig\n}\n\nexport async function getConversationHistory(leadId: string): Promise<Message[]> {\n  const supabase = await createClient()\n  const { data, error } = await supabase\n    .from(\"messages\")\n    .select(\"*\")\n    .eq(\"lead_id\", leadId)\n    .order(\"created_at\", { ascending: true })\n\n  if (error) {\n    console.error(\"Error fetching conversation history:\", error)\n    return []\n  }\n\n  return data as Message[]\n}\n\nexport function calculateMAO(arv: number, repairs: number, fee: number, multiplier = 0.7): number {\n  // MAO = (ARV Ã— multiplier) â€“ Repairs â€“ Fee\n  const mao = arv * multiplier - repairs - fee\n  return Math.max(0, Math.round(mao))\n}\n\nexport async function generateAgentResponse(\n  lead: Lead,\n  incomingMessage: string,\n  config: AgentConfig,\n): Promise<AgentResponse> {\n  // Cache Router short-circuit for FAQ intents in app reply flow\n  try {\n    const { classifyIntent, normalizeQuestion, lookupCached } = await import(\"@/lib/cache-router\")\n    const { findCachedByEmbedding } = await import(\"@/lib/llm-cache\")\n    const intent = classifyIntent(incomingMessage)\n    if (config.llm_cache_enabled !== false && (intent as string).startsWith(\"FAQ\")) {\n      const norm = normalizeQuestion(incomingMessage)\n      const { text, confidence } = await lookupCached(intent as any, norm)\n      if (text && confidence >= 0.85) {\n        return {\n          message: text,\n          updatedLead: {},\n          newState: undefined,\n          modelUsed: \"gpt-5.1\", // null not allowed in AgentResponse type here; tracked separately in messages\n          escalated: false,\n          callIntent: { action: \"none\" },\n        }\n      } else {\n        let floor = typeof config.llm_cache_confidence_floor === \"number\" ? config.llm_cache_confidence_floor : 0.85\n        let ttlDays =\n          (intent as string).startsWith(\"FAQ\")\n            ? (config.llm_cache_ttl_faq_days as number) ?? 30\n            : (config.llm_cache_ttl_objection_days as number) ?? 14\n        const market = lead.state || undefined\n        const overrides = (config.llm_cache_market_overrides || {}) as any\n        if (market && overrides[market]) {\n          floor = overrides[market].confidence_floor ?? floor\n          ttlDays = (intent as string).startsWith(\"FAQ\")\n            ? overrides[market].ttl_faq_days ?? ttlDays\n            : overrides[market].ttl_objection_days ?? ttlDays\n        }\n        const emb = await findCachedByEmbedding(intent as any, incomingMessage, market, floor, ttlDays)\n        if (emb.text && emb.confidence >= 0.85) {\n          return {\n            message: emb.text,\n            updatedLead: {},\n            newState: undefined,\n            modelUsed: \"gpt-5.1\",\n            escalated: false,\n            callIntent: { action: \"none\" },\n          }\n        }\n      }\n    }\n  } catch {}\n  const conversationHistory = await getConversationHistory(lead.id)\n\n  const shouldEscalate = shouldEscalateToNodeB(incomingMessage, lead.conversation_state)\n  const systemPrompt = shouldEscalate ? NODE_B_SYSTEM_PROMPT : NODE_A_SYSTEM_PROMPT\n\n  const tone = lead.pipeline_status === \"HOT\" ? \"closer, professional, concise\" : \"friendly, helpful, concise\"\n  const leadContext = `\nLEAD INFORMATION:\n- Name: ${lead.name}\n- Address: ${lead.address}\n- Phone: ${lead.phone_number}\n- Current State: ${lead.conversation_state}\n- Property Condition: ${lead.property_condition || \"Unknown\"}\n- Motivation: ${lead.motivation || \"Unknown\"}\n- Timeline: ${lead.timeline || \"Unknown\"}\n- Price Expectation: ${lead.price_expectation ? `$${lead.price_expectation.toLocaleString()}` : \"Unknown\"}\n- Mortgage Owed: ${typeof lead.mortgage_owed === \"number\" ? `$${lead.mortgage_owed.toLocaleString()}` : \"Unknown\"}\n- ARV (if available): ${lead.arv ? `$${lead.arv.toLocaleString()}` : \"Not yet determined\"}\n- Repair Estimate: ${lead.repair_estimate ? `$${lead.repair_estimate.toLocaleString()}` : \"Not yet determined\"}\n- Offer Amount: ${lead.offer_amount ? `$${lead.offer_amount.toLocaleString()}` : \"Not yet made\"}\n- Notes: ${lead.notes || \"None\"}\n\nCOMPANY CONFIG:\n- Company Name: ${config.company_name}\n- Wholesaling Fee: $${config.wholesaling_fee.toLocaleString()}\n- ARV Multiplier: ${config.arv_multiplier}\n \nTONE: ${tone}\n`\n\n  const conversationContext = conversationHistory\n    .map((msg) => `${msg.direction === \"inbound\" ? \"SELLER\" : \"AGENT\"}: ${msg.content}`)\n    .join(\"\\n\")\n\n  const prompt = shouldEscalate\n    ? `${leadContext}\n\nCONVERSATION HISTORY:\n${conversationContext || \"No previous messages\"}\n\nLATEST MESSAGE FROM SELLER (ESCALATED - Complex negotiation/agreement detected):\n${incomingMessage}\n\nThis conversation has been escalated to you because the seller is either:\n- Ready to accept an offer\n- Raising complex objections requiring negotiation\n- Discussing contract terms\n\nGenerate an appropriate SMS response handling this advanced scenario.\n\nAlso analyze and extract any new information about:\n- Property condition, motivation, timeline, price expectation\n\nRespond in JSON format:\n{\n  \"smsResponse\": \"Your SMS response (professional, can be slightly longer for complex topics)\",\n  \"callIntent\": {\n    \"action\": \"update_lead_status|none\",\n    \"lead_status\": \"warm_call_requested|schedule_call|ready_for_offer_call|text_only|null\",\n    \"call_time\": \"optional\"\n  },\n  \"extractedInfo\": {\n    \"propertyCondition\": \"extracted or null\",\n    \"motivation\": \"extracted or null\",\n    \"timeline\": \"extracted or null\",\n    \"priceExpectation\": \"number or null\"\n  },\n  \"suggestedState\": \"new state or null\",\n  \"shouldMakeOffer\": true/false,\n  \"offerAccepted\": true/false,\n  \"counterOfferAmount\": \"number if seller made counter, else null\",\n  \"readyForContract\": true/false\n}`\n    : `${leadContext}\n\nCONVERSATION HISTORY:\n${conversationContext || \"No previous messages\"}\n\nLATEST MESSAGE FROM SELLER:\n${incomingMessage}\n\nGenerate an appropriate SMS response to qualify this lead. Focus on gathering information about property condition, motivation, timeline, price expectations, and mortgage owed if mentioned.\n\nAlso analyze call intent - the seller may be hinting they want to talk on the phone instead of text.\n\nRespond in JSON format:\n{\n  \"smsResponse\": \"Your SMS response (keep it short, 1-2 messages max)\",\n  \"callIntent\": {\n    \"action\": \"update_lead_status|none\",\n    \"lead_status\": \"warm_call_requested|schedule_call|ready_for_offer_call|text_only|null\",\n    \"call_time\": \"optional\"\n  },\n  \"extractedInfo\": {\n    \"propertyCondition\": \"extracted or null\",\n    \"motivation\": \"extracted or null\",\n    \"timeline\": \"extracted or null\",\n    \"priceExpectation\": \"number or null\",\n    \"mortgageOwed\": \"number or null\"\n  },\n  \"suggestedState\": \"new state or null\",\n  \"shouldMakeOffer\": true/false,\n  \"needsEscalation\": true/false\n}`\n\n  const { text } = await callOpenAI(systemPrompt, prompt)\n\n  let parsed\n  try {\n    const jsonMatch = text.match(/\\{[\\s\\S]*\\}/)\n    if (jsonMatch) {\n      parsed = JSON.parse(jsonMatch[0])\n    } else {\n      parsed = { smsResponse: text, callIntent: { action: \"none\" }, extractedInfo: {} }\n    }\n  } catch {\n    parsed = { smsResponse: text, callIntent: { action: \"none\" }, extractedInfo: {} }\n  }\n\n  const updatedLead: Partial<Lead> = {}\n\n  if (parsed.extractedInfo?.propertyCondition) {\n    updatedLead.property_condition = parsed.extractedInfo.propertyCondition\n  }\n  if (parsed.extractedInfo?.motivation) {\n    updatedLead.motivation = parsed.extractedInfo.motivation\n  }\n  if (parsed.extractedInfo?.timeline) {\n    updatedLead.timeline = parsed.extractedInfo.timeline\n  }\n  if (parsed.extractedInfo?.priceExpectation) {\n    updatedLead.price_expectation = Number(parsed.extractedInfo.priceExpectation)\n  }\n  if (parsed.counterOfferAmount) {\n    updatedLead.notes = `${lead.notes || \"\"}\\nSeller counter offer: $${parsed.counterOfferAmount}`.trim()\n    updatedLead.offer_amount = Number(parsed.counterOfferAmount)\n  }\n\n  try {\n    const { scoreLead } = await import(\"@/lib/scoring\")\n    const s = scoreLead(lead, conversationHistory)\n    updatedLead.score = s\n    updatedLead.score_updated_at = new Date().toISOString() as any\n  } catch {}\n\n  let newState: Lead[\"conversation_state\"] | undefined\n  if (parsed.offerAccepted || parsed.readyForContract) {\n    newState = \"offer_accepted\"\n  } else if (parsed.shouldMakeOffer && lead.conversation_state !== \"offer_made\") {\n    newState = \"offer_made\"\n  } else if (parsed.suggestedState) {\n    newState = parsed.suggestedState\n  }\n\n  if (parsed.extractedInfo?.mortgageOwed) {\n    updatedLead.mortgage_owed = Number(parsed.extractedInfo.mortgageOwed)\n  }\n\n  const callIntent: CallIntentAction = parsed.callIntent || { action: \"none\" }\n\n  if ((parsed.shouldMakeOffer || parsed.readyForContract) && lead.arv && lead.repair_estimate) {\n    updatedLead.offer_amount = calculateMAO(lead.arv, lead.repair_estimate, config.wholesaling_fee, config.arv_multiplier)\n  }\n\n  try {\n    const { enforceRails, mao } = await import(\"@/lib/negotiation-rails\")\n    const base = mao(lead.arv || 0, lead.repair_estimate || 0, config.wholesaling_fee, config.arv_multiplier)\n    const r = enforceRails(lead, base, updatedLead.offer_amount || undefined)\n    if (!r.allowed && r.nextAmount) updatedLead.offer_amount = r.nextAmount\n  } catch {}\n\n  return {\n    message: parsed.smsResponse,\n    updatedLead,\n    newState,\n    modelUsed: \"gpt-5.1\",\n    escalated: shouldEscalate,\n    callIntent,\n  }\n}\n\nexport async function generateInitialOutreach(lead: Lead, config: AgentConfig): Promise<string> {\n  return `Hi ${lead.name}, this is ${config.company_name}. Are you still interested in selling ${lead.address}? We make fair cash offers and can close quickly. Reply YES if you'd like to learn more!`\n}\n\nexport async function generateFollowUp(lead: Lead, config: AgentConfig): Promise<string> {\n  switch (lead.conversation_state) {\n    case \"contacted\":\n      return `Hi ${lead.name}, just following up on my message about ${lead.address}. We're still interested in making you a fair cash offer. Let me know if you have any questions!`\n    case \"offer_made\":\n      return `Hi ${lead.name}, just checking if you had a chance to consider our offer of $${lead.offer_amount?.toLocaleString()} for ${lead.address}. Let me know your thoughts!`\n    case \"contract_sent\":\n      return `Hi ${lead.name}, just checking if you had a chance to review the contract for ${lead.address}. Let me know if you have any questions!`\n    default:\n      return `Hi ${lead.name}, this is ${config.company_name} following up about ${lead.address}. Are you still interested in selling? We'd love to help!`\n  }\n}\n","\"use server\"\n\nimport { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nconst supabase = createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!, {\n  cookies: {\n    getAll: async () => (await cookies()).getAll(),\n    setAll: async (cookiesToSet) => {\n      const cookieStore = await cookies()\n      cookiesToSet.forEach(({ name, value, options }) => {\n        cookieStore.set(name, value, options)\n      })\n    },\n  },\n})\n\nexport interface VoiceCall {\n  id: string\n  lead_id: string\n  call_type: \"inbound\" | \"outbound\"\n  call_status: string\n  twilio_call_sid: string | null\n  duration_seconds: number | null\n  transcript: string | null\n  summary: string | null\n  offer_discussed: boolean\n  offer_amount: number | null\n  next_steps: string | null\n  sentiment: string | null\n  created_at: string\n  updated_at: string\n}\n\nexport async function createCall(leadId: string, callType: \"inbound\" | \"outbound\"): Promise<VoiceCall | null> {\n  try {\n    const { data, error } = await supabase.from(\"calls\").insert({\n      lead_id: leadId,\n      call_type: callType,\n      call_status: \"pending\",\n    })\n\n    if (error) {\n      console.error(\"[Voice Calls] Create error:\", error)\n      return null\n    }\n\n    return data ? data[0] : null\n  } catch (error) {\n    console.error(\"[Voice Calls] Unexpected error:\", error)\n    return null\n  }\n}\n\nexport async function updateCall(callId: string, updates: Partial<VoiceCall>): Promise<VoiceCall | null> {\n  try {\n    const { data, error } = await supabase.from(\"calls\").update(updates).eq(\"id\", callId).select()\n\n    if (error) {\n      console.error(\"[Voice Calls] Update error:\", error)\n      return null\n    }\n\n    return data ? data[0] : null\n  } catch (error) {\n    console.error(\"[Voice Calls] Unexpected error:\", error)\n    return null\n  }\n}\n\nexport async function getCallsByLead(leadId: string): Promise<VoiceCall[]> {\n  try {\n    const { data, error } = await supabase\n      .from(\"calls\")\n      .select(\"*\")\n      .eq(\"lead_id\", leadId)\n      .order(\"created_at\", { ascending: false })\n\n    if (error) {\n      console.error(\"[Voice Calls] Get error:\", error)\n      return []\n    }\n\n    return data || []\n  } catch (error) {\n    console.error(\"[Voice Calls] Unexpected error:\", error)\n    return []\n  }\n}\n\nexport async function addCallEvent(callId: string, eventType: string, eventData: any): Promise<void> {\n  try {\n    await supabase.from(\"call_events\").insert({\n      call_id: callId,\n      event_type: eventType,\n      event_data: eventData,\n    })\n  } catch (error) {\n    console.error(\"[Call Events] Error:\", error)\n  }\n}\n\nexport async function getCallById(callId: string): Promise<VoiceCall | null> {\n  try {\n    const { data, error } = await supabase.from(\"calls\").select(\"*\").eq(\"id\", callId).single()\n    if (error || !data) return null\n    return data as VoiceCall\n  } catch (error) {\n    console.error(\"[Voice Calls] Get by id error:\", error)\n    return null\n  }\n}\n\nexport async function triggerVoiceCall(\n  leadId: string,\n  callIntentStatus: string,\n  scheduledTime?: string,\n): Promise<void> {\n  try {\n    // Create a pending call record\n    const call = await createCall(leadId, \"outbound\")\n\n    if (!call) {\n      console.error(`[Voice Call] Failed to create call record for lead: ${leadId}`)\n      return\n    }\n\n    // Log the call intent event\n    await addCallEvent(call.id, \"call_intent_detected\", {\n      intent_status: callIntentStatus,\n      scheduled_time: scheduledTime,\n      triggered_at: new Date().toISOString(),\n    })\n\n    console.log(`[Voice Call Triggered] Call ID: ${call.id}, Lead ID: ${leadId}, Status: ${callIntentStatus}`)\n\n    // If scheduled for later, you could implement a scheduling system here\n    // For now, mark as pending and let the voice agent handle the outbound call\n    if (scheduledTime) {\n      await addCallEvent(call.id, \"call_scheduled\", {\n        scheduled_time: scheduledTime,\n      })\n    } else if (callIntentStatus === \"warm_call_requested\" || callIntentStatus === \"ready_for_offer_call\") {\n      // Immediately initiate the call via Twilio\n      try {\n        const response = await fetch(\n          `${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/api/twilio/voice/outbound`,\n          {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({\n              leadId,\n              callIntentStatus,\n            }),\n          },\n        )\n\n        if (!response.ok) {\n          console.error(`[Voice Call] Outbound call API failed:`, await response.text())\n        }\n      } catch (error) {\n        console.error(`[Voice Call] Error initiating outbound call:`, error)\n      }\n    }\n  } catch (error) {\n    console.error(`[Voice Call] Error triggering voice call for lead ${leadId}:`, error)\n  }\n}\n","import { createClient } from \"@/lib/supabase/server\"\nimport { FAQ_DEFAULT } from \"@/lib/faq/default\"\n\nexport type Intent =\n  | \"FAQ_PROCESS\"\n  | \"FAQ_FEES\"\n  | \"FAQ_TRUST\"\n  | \"FAQ_CONTRACT\"\n  | \"FAQ_GENERAL\"\n  | \"PROPERTY_SPECIFIC\"\n  | \"NEGOTIATION\"\n  | \"EMOTIONAL\"\n  | \"UNKNOWN\"\n\nexport function normalizeQuestion(raw: string): string {\n  return raw.toLowerCase().replace(/[^\\w\\s]/g, \"\").replace(/\\s+/g, \" \").trim()\n}\n\nexport function classifyIntent(raw: string): Intent {\n  const q = raw.toLowerCase()\n  const has = (...words: string[]) => words.some((w) => q.includes(w))\n  if (has(\"how does\", \"how it works\", \"process\", \"timeline\", \"close\", \"closing\", \"offer\", \"cash offer\", \"sell fast\", \"same-day\", \"comps\", \"valuation\")) return \"FAQ_PROCESS\"\n  if (has(\"fee\", \"fees\", \"commission\", \"commissions\", \"costs\", \"closing costs\", \"assignment fee\")) return \"FAQ_FEES\"\n  if (has(\"scam\", \"legitimate\", \"legit\", \"credentials\", \"license\", \"are you real\", \"wholesaler\")) return \"FAQ_TRUST\"\n  if (has(\"contract\", \"assignable\", \"assignability\", \"cancel\", \"cancellation\", \"inspection\", \"inspection period\", \"earnest\", \"valid\", \"validity\", \"expires\")) return \"FAQ_CONTRACT\"\n  if (has(\"tenants\", \"mortgage\", \"liens\", \"inherited\", \"probate\", \"as-is\", \"repairs\", \"access\", \"lockbox\", \"opt-out\", \"unsubscribe\", \"agent\", \"broker\", \"bankruptcy\", \"multiple properties\")) return \"FAQ_GENERAL\"\n  if (has(\"address\", \"street\", \"zip\", \"city\", \"state\")) return \"PROPERTY_SPECIFIC\"\n  if (has(\"price\", \"offer more\", \"counter\", \"too low\", \"higher\")) return \"NEGOTIATION\"\n  if (has(\"stress\", \"urgent\", \"emergency\", \"foreclosure\", \"behind on payments\")) return \"EMOTIONAL\"\n  return \"UNKNOWN\"\n}\n\nexport async function lookupCached(intent: Intent, qNorm: string): Promise<{ text: string | null; confidence: number }> {\n  try {\n    const supabase = await createClient()\n    const { data: exact } = await supabase\n      .from(\"cached_responses\")\n      .select(\"id,response_text\")\n      .eq(\"intent\", intent)\n      .eq(\"normalized_question\", qNorm)\n      .limit(1)\n      .maybeSingle()\n    if (exact?.response_text) {\n      await supabase.from(\"cached_hits\").insert({ cached_response_id: exact.id, question_raw: qNorm, matched_confidence: 1.0 })\n      return { text: exact.response_text, confidence: 1.0 }\n    }\n    const { data: similar } = await supabase\n      .from(\"cached_responses\")\n      .select(\"id,response_text,normalized_question\")\n      .eq(\"intent\", intent)\n      .limit(5)\n    const s = (similar || []).find((r: any) => String(r.normalized_question || \"\").includes(qNorm.split(\" \").slice(0, 4).join(\" \")))\n    if (s?.response_text) {\n      await supabase.from(\"cached_hits\").insert({ cached_response_id: s.id, question_raw: qNorm, matched_confidence: 0.85 })\n      return { text: s.response_text, confidence: 0.85 }\n    }\n  } catch {}\n  const norm = (s: string) => s.toLowerCase().replace(/[^\\w\\s]/g, \"\").replace(/\\s+/g, \" \").trim()\n  const localExact = FAQ_DEFAULT.find((i) => i.intent === intent && norm(i.question) === qNorm)\n  if (localExact) return { text: localExact.response, confidence: 0.95 }\n  const localSimilar = FAQ_DEFAULT.find((i) => i.intent === intent && norm(i.question).includes(qNorm.split(\" \").slice(0, 4).join(\" \")))\n  if (localSimilar) return { text: localSimilar.response, confidence: 0.9 }\n  return { text: null, confidence: 0 }\n}\n\nexport async function storeCached(intent: Intent, qNorm: string, text: string): Promise<void> {\n  const supabase = await createClient()\n  await supabase\n    .from(\"cached_responses\")\n    .upsert({ intent, normalized_question: qNorm, response_text: text, updated_at: new Date().toISOString() }, { onConflict: \"intent,normalized_question\" })\n}\n","export const FAQ_DEFAULT = [\n  { intent: \"FAQ_PROCESS\", question: \"How does this process work?\", response: \"We purchase homes directly for cash. After your property details are verified, we send a contract, and once signed, we match your property with buyers and move to closing.\" },\n  { intent: \"FAQ_PROCESS\", question: \"How long does it take to close?\", response: \"Closing typically takes 14â€“30 days depending on inspections, title, and buyer readiness.\" },\n  { intent: \"FAQ_CONTRACT\", question: \"Do I need an inspection?\", response: \"We buy asâ€‘is. Inspections are optional and used to confirm details during the dueâ€‘diligence period.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Do you buy homes asâ€‘is?\", response: \"Yes, we purchase properties in their current condition. No repairs or cleaning needed.\" },\n  { intent: \"FAQ_PROCESS\", question: \"How do you determine your offer?\", response: \"We calculate offers using recent comps, repair estimates, and our MAO formula to ensure a fair, realistic price.\" },\n  { intent: \"NEGOTIATION\", question: \"Your offer is too low\", response: \"I understand. We aim to be competitive while factoring repairs and market data. Can we review comps together and see where we can meet?\" },\n  { intent: \"NEGOTIATION\", question: \"I want more for my home\", response: \"I hear you. Our offer reflects current market and repairs. Letâ€™s walk through the numbers and see if adjustments make sense.\" },\n  { intent: \"FAQ_CONTRACT\", question: \"Do I need to put down earnest money?\", response: \"No. As the seller, you do not provide earnest money. We handle earnest deposits with title when applicable.\" },\n  { intent: \"FAQ_FEES\", question: \"Do I pay closing costs?\", response: \"We typically cover standard closing costs, so you wonâ€™t pay anything out of pocket.\" },\n  { intent: \"FAQ_PROCESS\", question: \"When will I get paid?\", response: \"Funds are disbursed at closing â€” typically same day via wire or cashierâ€™s check.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Do I need to provide access?\", response: \"Weâ€™ll coordinate access with you, a key, or a lockbox so qualified buyers can view the property if needed.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Do I need to fix anything before selling?\", response: \"No, we buy asâ€‘is. Any repairs are factored into our offer â€” you donâ€™t need to spend upfront.\" },\n  { intent: \"FAQ_TRUST\", question: \"Are you a wholesaler?\", response: \"Yes, we operate as compliant investors/wholesalers. We use standard agreements and licensed title companies.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Can you take over my mortgage?\", response: \"In some cases we can take over payments subjectâ€‘to existing financing. We review details case by case.\" },\n  { intent: \"FAQ_GENERAL\", question: \"How do I optâ€‘out?\", response: \"Reply STOP at any time to unsubscribe from SMS updates.\" },\n  { intent: \"NEGOTIATION\", question: \"I need to think about it\", response: \"Absolutely â€” take the time you need. We can follow up in a few days if that works for you.\" },\n  { intent: \"NEGOTIATION\", question: \"Contact me later\", response: \"No problem. Tell me a good date and time, and Iâ€™ll follow up then.\" },\n  { intent: \"NEGOTIATION\", question: \"Iâ€™m not sure this is right for me\", response: \"Totally fair. Iâ€™m happy to answer questions so you can decide whatâ€™s best for your situation.\" },\n  { intent: \"NEGOTIATION\", question: \"Iâ€™m too busy right now\", response: \"Understood. We can schedule a quick call or text at a convenient time for you.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Do I need to paint or fix small things?\", response: \"No â€” we buy asâ€‘is, including minor issues. No prep needed.\" },\n  { intent: \"FAQ_GENERAL\", question: \"What about big repairs?\", response: \"We account for major repairs in our offer, so you wonâ€™t have to fix them first.\" },\n  { intent: \"FAQ_PROCESS\", question: \"Do I get multiple offers?\", response: \"Yes. We broadcast to vetted buyers and help you evaluate the strongest offers.\" },\n  { intent: \"FAQ_PROCESS\", question: \"How do I know which offer is best?\", response: \"We compare offers by price, terms, and buyer reliability to help you choose confidently.\" },\n  { intent: \"FAQ_FEES\", question: \"What is an assignment fee?\", response: \"Itâ€™s the fee paid to the wholesaler for securing the contract and finding a buyer.\" },\n  { intent: \"FAQ_CONTRACT\", question: \"How long is your offer valid?\", response: \"Offers are typically valid 48â€“72 hours to give you time to review and decide.\" },\n  { intent: \"FAQ_PROCESS\", question: \"I need to sell fast\", response: \"We specialize in quick closings and can often close in 14â€“21 days.\" },\n  { intent: \"FAQ_PROCESS\", question: \"Can I wait longer?\", response: \"Yes, we can accommodate your timeline. Just note the market can shift, affecting price.\" },\n  { intent: \"FAQ_PROCESS\", question: \"How do you calculate market value?\", response: \"We use recent comparable sales near your property along with current demand and condition.\" },\n  { intent: \"FAQ_PROCESS\", question: \"Do you subtract repair costs?\", response: \"Yes. Repair estimates are built into the offer so the number is realistic.\" },\n  { intent: \"FAQ_GENERAL\", question: \"How will you contact me?\", response: \"We use SMS and phone, aligned to your preferences.\" },\n  { intent: \"FAQ_TRUST\", question: \"Is my info confidential?\", response: \"Yes. Your information is kept confidential and only used for evaluating the property and closing.\" },\n  { intent: \"FAQ_FEES\", question: \"Are there any hidden fees?\", response: \"No hidden fees. Our process is transparent, and you wonâ€™t pay outâ€‘ofâ€‘pocket.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Iâ€™m moving out of state\", response: \"We can work remotely and handle documents online with the title company.\" },\n  { intent: \"FAQ_PROCESS\", question: \"Can we close sameâ€‘day?\", response: \"Rarely; proper processing is needed. 1â€“2 weeks is typical, though we expedite when possible.\" },\n  { intent: \"FAQ_GENERAL\", question: \"Do I need a real estate agent?\", response: \"No agent is required â€” we handle the purchase directly.\" },\n  { intent: \"FAQ_GENERAL\", question: \"I have a bankruptcy, can I sell?\", response: \"Yes. We review the specifics but bankruptcy doesnâ€™t necessarily prevent closing.\" },\n  { intent: \"FAQ_GENERAL\", question: \"I have multiple properties\", response: \"We can evaluate each and even structure portfolio deals.\" },\n]\n","import { createClient } from \"@/lib/supabase/server\"\nimport twilio from \"twilio\"\n\nfunction getTwilioClient() {\n  const sid = process.env.TWILIO_ACCOUNT_SID\n  const token = process.env.TWILIO_AUTH_TOKEN\n  if (!sid || !token) return null\n  return twilio(sid, token)\n}\n\nexport async function notifyHotLead(lead: { id: string; name: string; phone_number: string; address: string }) {\n  try {\n    const supabase = await createClient()\n    await supabase.from(\"a2p_logs\").insert({\n      entity_type: \"lead\",\n      entity_id: lead.id,\n      level: \"info\",\n      message: \"hot_lead\",\n      meta: { name: lead.name, phone: lead.phone_number, address: lead.address },\n    })\n  } catch {}\n\n  const text = `HOT Lead: ${lead.name}\\n${lead.address}\\nPhone: ${lead.phone_number}`\n\n  // SMS admin notify\n  try {\n    const adminPhone = process.env.ADMIN_NOTIFY_PHONE\n    const fromNumber = process.env.TWILIO_PHONE_NUMBER\n    const client = getTwilioClient()\n    if (client && adminPhone && fromNumber) {\n      await client.messages.create({ to: adminPhone, from: fromNumber, body: text })\n    }\n  } catch {}\n\n  // Telegram notify\n  try {\n    const token = process.env.TELEGRAM_BOT_TOKEN\n    const chatId = process.env.TELEGRAM_CHAT_ID\n    if (token && chatId) {\n      await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ chat_id: chatId, text }),\n      })\n    }\n  } catch {}\n}\n","import OpenAI from \"openai\"\nimport { createServiceClient } from \"@/lib/supabase/service\"\n\nfunction dot(a: number[], b: number[]) {\n  let s = 0\n  for (let i = 0; i < Math.min(a.length, b.length); i++) s += a[i] * b[i]\n  return s\n}\nfunction norm(a: number[]) {\n  return Math.sqrt(a.reduce((s, v) => s + v * v, 0))\n}\nfunction cosine(a: number[], b: number[]) {\n  const na = norm(a)\n  const nb = norm(b)\n  if (!na || !nb) return 0\n  return dot(a, b) / (na * nb)\n}\n\nexport async function embedQuery(text: string): Promise<number[]> {\n  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! })\n  const emb = await openai.embeddings.create({ model: \"text-embedding-3-small\", input: text })\n  return emb.data[0].embedding as unknown as number[]\n}\n\nexport async function findCachedByEmbedding(\n  intent: string,\n  query: string,\n  market?: string,\n  floor: number = 0.85,\n  ttlDays?: number,\n): Promise<{ text: string | null; confidence: number; id?: string }> {\n  const svc = createServiceClient()\n  const vec = await embedQuery(query)\n  let q = svc.from(\"cached_responses\").select(\"id,response_text,embedding,intent,market,usage_count,created_at\").eq(\"intent\", intent)\n  if (market) q = q.eq(\"market\", market)\n  const { data } = await q.limit(200)\n  const now = Date.now()\n  const maxAgeMs = typeof ttlDays === \"number\" && ttlDays > 0 ? ttlDays * 24 * 60 * 60 * 1000 : undefined\n  const filtered = (data || []).filter((row: any) => {\n    if (!maxAgeMs) return true\n    const created = new Date(row.created_at).getTime()\n    return now - created <= maxAgeMs\n  })\n  const scored = filtered.map((row: any) => ({ id: row.id, text: row.response_text as string, score: cosine(vec, (row.embedding as any) || []) }))\n  scored.sort((a, b) => b.score - a.score)\n  const best = scored[0]\n  if (best && best.score >= floor) {\n    const current = (data || []).find((d: any) => d.id === best.id)\n    await svc\n      .from(\"cached_responses\")\n      .update({ usage_count: ((current?.usage_count as number) || 0) + 1, last_used_at: new Date().toISOString() })\n      .eq(\"id\", best.id)\n    return { text: best.text, confidence: best.score, id: best.id }\n  }\n  return { text: null, confidence: 0 }\n}\n"],"names":["module","exports","require","vendored","ReactServerDOMTurbopackServer","registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"s3BAAA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEO,eAAe,IACpB,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAEjC,MAAO,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAA,mNAAoF,CAC3G,QAAS,QACP,IACS,EAAY,MAAM,GAE3B,OAAO,CAAY,EACjB,GAAI,CACF,EAAa,OAAO,CAAC,CAAC,MAAE,CAAI,OAAE,CAAK,SAAE,CAAO,CAAE,GAAK,EAAY,GAAG,CAAC,EAAM,EAAO,GAClF,CAAE,KAAM,CAER,CACF,CACF,CACF,EACF,kOCpBA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAa,QAAQ,GAAG,CAAC,kBAAkB,CAC3C,EAAY,QAAQ,GAAG,CAAC,iBAAiB,CACzC,EAAoB,QAAQ,GAAG,CAAC,mBAAmB,CACnD,EAAiB,QAAQ,GAAG,CAAC,gBAAgB,CAC7C,EAAmB,CAAC,QAAQ,GAAG,CAAC,kBAAkB,EAAI,EAAA,CAAE,CAC3D,KAAK,CAAC,KACN,GAAG,CAAC,AAAC,GAAM,EAAE,IAAI,IACjB,MAAM,CAAE,AAAD,GAAO,EAAE,MAAM,CAAG,GACtB,EAAwB,OAAO,QAAQ,GAAG,CAAC,4BAA4B,EAAI,KA6C1E,eAAe,IACpB,IAAM,EAAO,EAAiB,MAAM,CAAG,EAAI,EAAoB,EAAoB,CAAC,EAAkB,CAAG,EAAE,CAC3G,GAAoB,IAAhB,EAAK,MAAM,CAAQ,MAAO,EAAE,CAChC,GAAI,CACF,MAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,MAAE,CAAI,CAAE,CAAG,MAAM,EACpB,IAAI,CAAC,eACL,MAAM,CAAC,0BACP,EAAE,CAAC,aAAc,YACjB,GAAG,CAAC,cAlDT,AAkDuB,CAnDjB,EAAI,IAAI,MACZ,OAAO,CAAC,GACV,EAAE,QAAQ,CAAC,EAAG,EAAG,EAAG,GACb,EAAE,WAAW,KAiDZ,EAAiC,CAAC,EACxC,IAAK,IAAM,KAAO,GAAQ,EAAE,CAAE,CAC5B,IAAM,EAAQ,EAAY,UAAU,EAAE,IAClC,CAAgB,iBAAT,IAAmB,CAAM,CAAC,EAAK,CAAG,CAAC,CAAM,CAAC,EAAK,GAAI,CAAC,EAAI,CACrE,CAEA,OADiB,AACV,EADe,MAAM,CAAC,AAAC,GAAQ,CAAC,CAAM,CAAC,EAAI,EAAI,CAAC,EAAI,GAC3C,IAAI,CAAC,CAAC,EAAG,IAAM,CAAC,CAAM,CAAC,EAAE,GAAI,CAAC,EAAK,CAAM,CAAP,AAAQ,EAAE,GAAI,CAAC,CACnE,CAAE,KAAM,CACN,OAAO,CACT,CACF,CAGO,SAAS,WACd,AAAI,AAAC,GAAe,EAIb,CAAA,EAAA,EAAA,IAJY,AAAY,GAIxB,AAAM,EAAC,EAAY,IAHxB,QAAQ,IAAI,CAAC,qCACN,KAGX,CAEO,SAAS,IACd,GAAI,GAAkB,EAAe,MAAM,CAAG,EAAG,OAAO,EACxD,IAAM,EAAO,EAAiB,MAAM,CAAG,EAAI,EAAoB,EAAoB,CAAC,EAAkB,CAAG,EAAE,CAC3G,OAAO,EAAK,MAAM,CAAG,EAAI,CAAI,CAAC,EAAE,CAAG,IACrC,CAEO,eAAe,EACpB,CAAU,CACV,CAAY,CACZ,CAA4D,EAE5D,IAAM,EAAS,IAEf,GAAI,CAAC,EAAQ,CACX,IAAM,EAAU,GAAM,aAAc,EAAQ,gCAAkC,GACxE,EAAW,CAAA,EAAG,EAAA,EAAO,EAAA,CAAQ,CAEnC,OADA,QAAQ,GAAG,CAAC,CAAC,eAAe,EAAE,GAAG;AAAA,SAAW,EAAE,EAAA,CAAU,EACjD,CAAE,IAAK,CAAC,KAAK,EAAE,KAAK,GAAG,GAAA,CAAI,CAAE,MAAO,IAAK,CAClD,CAGA,IAAM,EAAa,OAAO,QAAQ,GAAG,CAAC,qBAAqB,EAAI,GACzD,EAAW,OAAO,QAAQ,GAAG,CAAC,mBAAmB,EAAI,IACrD,EAAU,IAAI,OAAO,QAAQ,GACnC,GAAI,EAAU,GAAc,GAAW,EACrC,MAAO,CAAE,CADsC,GACjC,KAAM,MAAO,sCAAuC,EAIpE,GAAI,CAAC,GAAM,kBACT,CAD4B,EACxB,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC/B,EAAa,EAAG,OAAO,CAAC,MAAO,GACT,AAAtB,QAAW,MAAM,CAAS,EAAa,CAAC,EAAE,EAAE,EAAA,CAAY,CAC7B,KAAtB,EAAW,MAAM,EAAW,EAAW,UAAU,CAAC,KAAM,EAAa,CAAC,CAAC,EAAE,EAAA,CAAY,CACrF,AAAC,EAAW,UAAU,CAAC,OAAM,EAAa,CAAC,CAAC,EAAE,EAAA,CAAA,AAAY,EACnE,GAAM,CAAE,KAAM,CAAI,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,SAAS,MAAM,CAAC,KAAK,EAAE,CAAC,eAAgB,GAAY,MAAM,GACrG,GAAI,GAAS,EAAa,YAAY,CACpC,CADsC,KAC/B,CAAE,IAAK,KAAM,MAAO,yBAA0B,CAEzD,CAAE,KAAM,CAAC,CAGX,IAAM,EAAa,MAAM,IACzB,GAA0B,GAAG,CAAzB,EAAW,MAAM,CACnB,MAAO,CAAE,IAAK,KAAM,MAAO,0DAA2D,EAGxF,GAAI,CAEF,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAQ,IAAI,KAAK,KAAK,GAAG,GAAK,KAAQ,WAAW,GACjD,OAAE,CAAK,CAAE,CAAG,MAAM,EACrB,IAAI,CAAC,cACL,MAAM,CAAC,KAAM,CAAE,MAAO,QAAS,MAAM,CAAK,GAC1C,GAAG,CAAC,aAAc,GACf,EAAQ,OAAO,QAAQ,GAAG,CAAC,sBAAsB,EAAI,IAC3D,GAAI,CAAC,GAAS,CAAC,GAAK,EAClB,KADyB,CAClB,CAAE,IAAK,KAAM,MAAO,gCAAiC,CAEhE,CAAE,KAAM,CAAC,CACT,IAAM,EAAwB,EAAE,CAChC,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CAAE,KAAM,CAAG,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,gBAAgB,MAAM,CAAC,KAAK,KAAK,CAAC,GAAG,MAAM,GAC/E,EAAW,GAAa,cAAgB,eAC9C,EAAY,IAAI,CAAC,CAAA,EAAG,EAAQ,6BAA6B,CAAC,CAC5D,CAAE,KAAM,CACN,EAAY,IAAI,CAAC,8BACnB,CACA,EAAY,IAAI,CAAC,8BACjB,EAAY,IAAI,CAAC,uBACjB,EAAY,IAAI,CAAC,6BACjB,IAAM,EAAa,EAAY,IAAI,CAAC,OAC9B,EAAU,GAAM,YAAc,GAAQ,CAAC;AAAA;AAAI,EAAE,EAAA,CAAY,CAAG,GAC5D,EAAW,CAAA,EAAG,EAAA,EAAO,EAAA,CAAQ,CAC7B,EAAiB,CAAA,EAAG,QAAQ,GAAG,CAAC,mBAAmB,EAAI,wBAAwB,kBAAkB,CAAC,CAEpG,EAA2B,KAC/B,IAAK,IAAM,KAAc,EACvB,GAAI,CACF,IAAM,CAF2B,CAEjB,MAAM,EAAO,QAAQ,CAAC,MAAM,CAAC,CAC3C,KAAM,EACN,KAAM,KACN,iBACA,CACF,GACA,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,GACnC,OAAM,EAAS,IAAI,CAAC,cAAc,MAAM,CAAC,CACvC,IAAK,EAAQ,GAAG,CAChB,UAAW,EACX,YAAa,EACb,OAAQ,OACR,MAAO,UACP,CACF,EACF,CAAE,KAAM,CAAC,CACT,MAAO,CAAE,IAAK,EAAQ,GAAG,CAAE,MAAO,IAAK,CACzC,CAAE,MAAO,EAAQ,CACf,EAAY,GAAG,QAAU,OAAO,EAAE,OAAO,EAAI,qBAC7C,QACF,CAEF,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,GACnC,OAAM,EAAS,IAAI,CAAC,cAAc,MAAM,CAAC,CACvC,IAAK,KACL,UAAW,EACX,YAAa,CAAU,CAAC,EAAE,CAC1B,OAAQ,SACR,MAAO,GAAa,0BACpB,CACF,EACF,CAAE,KAAM,CAAC,CACT,MAAO,CAAE,IAAK,KAAM,MAAO,GAAa,oBAAqB,CAC/D,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,qBAAsB,GAC7B,CAAE,IAAK,KAAM,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,oBAAqB,CAC3F,CACF,CAEO,SAAS,EAAsB,CAAiB,CAAE,CAAW,CAAE,CAA8B,QAClG,CAAK,GAAD,AAKG,EAAA,MALS,CAKH,CAAC,eAAe,CAAC,EAAW,EAAW,EAAK,EAC3D,iKCzNAA,EAAOC,OAAO,CACZC,EAAQ,CAAA,CAAA,IAAA,GACRC,QAAQ,CAAC,YAAY,CAAEC,6BAA6B,+BCFF,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CC,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAsB,YAAlB,AAA8B,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,mBAAA,gBAAA,CAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,6BCHhB,IAAA,EAAA,EAAA,CAAA,CAAA,OAEO,SAAS,IAEd,IAAM,EAAM,QAAQ,GAAG,CAAC,yBAAyB,CACjD,MAAO,CAAA,EAAA,EAAA,YAAA,AAAY,EAFb,AAEc,2CAAK,EAC3B,4DCNA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAuB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA8F7B,CAAC,CAEI,EAAuB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;wEAwB0C,CAAC,CAEnE,EAAsB,CAC1B,QACA,SACA,OACA,gBACA,cACA,cACA,UACA,aACA,aACA,SACA,eACA,gBACA,WACA,SACA,gBACA,eACA,eACA,cACA,aACA,YACA,yBACA,SACA,WACA,QACA,iBACA,cACD,CAyCK,EAAS,IAAI,EAAA,OAAM,CAAC,CAAE,OAAQ,QAAQ,GAAG,CAAC,cAAc,AAAC,GAE/D,eAAe,EAAW,CAAoB,CAAE,CAAkB,EAChE,IAAM,EAAW,MAAM,EAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CACpD,MAAO,UACP,WAAY,IACZ,YAAa,GACb,SAAU,CACR,CAAE,KAAM,SAAU,QAAS,CAAa,EACxC,CAAE,KAAM,OAAQ,QAAS,CAAW,EACrC,AACH,GAEA,MAAO,CAAE,KADI,EAAS,OAAO,CAAC,EAAE,EAAE,SAAS,SAAW,GACvC,MAAO,EAAS,KAAK,AAAC,CACvC,CAEO,eAAe,IACpB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IACjB,MAAE,CAAI,CAAE,OAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,gBAAgB,MAAM,CAAC,KAAK,MAAM,UAE9E,AAAI,GAAS,CAAC,EAEL,CACL,GAHgB,AAGZ,GACJ,aAAc,uBACd,gBAAiB,IACjB,eAAgB,GAChB,gBAAiB,GACjB,eAAgB,EAChB,yBAA0B,GAC1B,sBAAuB,EACvB,mBAAmB,EACnB,2BAA4B,IAC5B,uBAAwB,GACxB,6BAA8B,GAC9B,yBAAyB,EACzB,gCAAiC,EACjC,2BAA4B,GAC5B,kCAAkC,EAClC,WAAY,IAAI,OAAO,WAAW,GAClC,WAAY,IAAI,OAAO,WAAW,EACpC,EAGK,CACT,CAEO,eAAe,EAAuB,CAAc,EACzD,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IACjB,CAAE,MAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,UAAW,GACd,KAAK,CAAC,aAAc,CAAE,WAAW,CAAK,UAEzC,AAAI,GACF,IADS,IACD,KAAK,CAAC,uCAAwC,GAC/C,EAAE,EAGJ,CACT,CAQO,eAAe,EACpB,CAAU,CACV,CAAuB,CACvB,CAAmB,MA0Jf,EAsCA,EA7LJ,GAAI,CACF,GAAM,gBAAE,CAAc,mBAAE,CAAiB,cAAE,CAAY,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OACtD,uBAAE,CAAqB,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAC5B,EAAS,EAAe,GAC9B,IAAiC,IAA7B,EAAO,iBAAiB,EAAe,EAAkB,UAAU,CAAC,OAAQ,CAC9E,IAAM,EAAO,EAAkB,GACzB,CAAE,MAAI,YAAE,CAAU,CAAE,CAAG,MAAM,EAAa,EAAe,GAC/D,GAAI,GAAQ,GAAc,IACxB,EAD8B,IACvB,CACL,QAAS,EACT,YAAa,CAAC,EACd,cAAU,EACV,UAAW,UACX,WAAW,EACX,WAAY,CAAE,OAAQ,MAAO,CAC/B,CACK,EACL,IAAI,EAAqD,UAA7C,OAAO,EAAO,0BAA0B,CAAgB,EAAO,0BAA0B,CAAG,IACpG,EACD,EAAkB,UAAU,CAAC,OACzB,EAAO,sBAAsB,EAAe,GAC5C,EAAO,4BAA4B,EAAe,GACnD,EAAS,EAAK,KAAK,OAAI,EACvB,EAAa,EAAO,0BAA0B,EAAI,CAAC,EACrD,GAAU,CAAS,CAAC,EAAO,EAAE,CAC/B,EAAQ,CAAS,CAAC,EAAO,CAAC,gBAAgB,EAAI,EAC9C,EAAW,EAAkB,UAAU,CAAC,OACpC,CAAS,CAAC,EAAO,CAAC,YAAY,EAAI,EAClC,CAAS,CAAC,EAAO,CAAC,kBAAkB,EAAI,GAE9C,IAAM,EAAM,MAAM,EAAsB,EAAe,EAAiB,EAAQ,EAAO,GACvF,GAAI,EAAI,IAAI,EAAI,EAAI,UAAU,EAAI,IAChC,EADsC,IAC/B,CACL,QAAS,EAAI,IAAI,CACjB,YAAa,CAAC,EACd,cAAU,EACV,UAAW,UACX,WAAW,EACX,WAAY,CAAE,OAAQ,MAAO,CAC/B,CAEJ,CACF,CACF,CAAE,KAAM,CAAC,CACT,IAAM,EAAsB,MAAM,EAAuB,EAAK,EAAE,EAE1D,EAhKR,AAgKyB,SAhKhB,AAAsB,CAAe,CAAE,CAAyB,EACvE,IAAM,EAAe,EAAQ,WAAW,GAGxC,GAAI,CAAC,aAAc,gBAAiB,iBAAiB,CAAC,QAAQ,CAAC,GAC7D,OAAO,EAIT,IAAK,IAL8E,AAKxE,KAAW,EACpB,GAAI,EAAa,QAAQ,CAAC,GACxB,CAFuC,KAEhC,CAD2B,EAStC,GAAI,AAHiB,oCAGJ,IAAI,CAAC,GACpB,KAAK,IAAM,GADwB,CAFT,CAAC,KAGN,CAHa,UAAW,SAGH,EAHe,SAAU,WAAY,KAAM,MAAM,CAIzF,GAAI,EAAa,QAAQ,CAAC,GACxB,MADiC,CAC1B,CAEX,CAGF,MAAO,EACT,EAoI+C,EAAiB,EAAK,kBAAkB,EAG/E,EAAgC,QAAzB,EAAK,eAAe,CAAa,gCAAkC,6BAC1E,EAAc,CAAC;;QAEf,EAAE,EAAK,IAAI,CAAC;WACT,EAAE,EAAK,OAAO,CAAC;SACjB,EAAE,EAAK,YAAY,CAAC;iBACZ,EAAE,EAAK,kBAAkB,CAAC;sBACrB,EAAE,EAAK,kBAAkB,EAAI,UAAU;cAC/C,EAAE,EAAK,UAAU,EAAI,UAAU;YACjC,EAAE,EAAK,QAAQ,EAAI,UAAU;qBACpB,EAAE,EAAK,iBAAiB,CAAG,CAAC,CAAC,EAAE,EAAK,iBAAiB,CAAC,cAAc,GAAA,CAAI,CAAG,UAAU;iBACzF,EAAgC,UAA9B,OAAO,EAAK,aAAa,CAAgB,CAAC,CAAC,EAAE,EAAK,aAAa,CAAC,cAAc,GAAA,CAAI,CAAG,UAAU;sBAC5F,EAAE,EAAK,GAAG,CAAG,CAAC,CAAC,EAAE,EAAK,GAAG,CAAC,cAAc,GAAA,CAAI,CAAG,qBAAqB;mBACvE,EAAE,EAAK,eAAe,CAAG,CAAC,CAAC,EAAE,EAAK,eAAe,CAAC,cAAc,GAAA,CAAI,CAAG,qBAAqB;gBAC/F,EAAE,EAAK,YAAY,CAAG,CAAC,CAAC,EAAE,EAAK,YAAY,CAAC,cAAc,GAAA,CAAI,CAAG,eAAe;SACvF,EAAE,EAAK,KAAK,EAAI,OAAO;;;gBAGhB,EAAE,EAAO,YAAY,CAAC;oBAClB,EAAE,EAAO,eAAe,CAAC,cAAc,GAAG;kBAC5C,EAAE,EAAO,cAAc,CAAC;;MAEpC,EAAE,KAAK;AACb,CAAC,CAEO,EAAsB,EACzB,GAAG,CAAC,AAAC,GAAQ,CAAA,EAAqB,YAAlB,EAAI,SAAS,CAAiB,SAAW,QAAQ,EAAE,EAAE,EAAI,OAAO,CAAA,CAAE,EAClF,IAAI,CAAC,MAEF,EAAS,EACX,CAAA,EAAG,YAAY;;;AAGrB,EAAE,GAAuB,uBAAuB;;;AAGhD,EAAE,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA+BjB,CAAC,CACI,CAAA,EAAG,YAAY;;;AAGrB,EAAE,GAAuB,uBAAuB;;;AAGhD,EAAE,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;CAwBjB,CAAC,CAEM,MAAE,CAAI,CAAE,CAAG,MAAM,EAtGF,EAAiB,EAAuB,EAsGb,GAAd,AAGlC,GAAI,CACF,IAAM,EAAY,EAAK,KAAK,CAAC,eAE3B,EADE,EACO,KAAK,IADD,CACM,CAAC,CAAS,CAAC,EAAE,EAEvB,CAAE,YAAa,EAAM,WAAY,CAAE,OAAQ,MAAO,EAAG,cAAe,CAAC,CAAE,CAEpF,CAAE,KAAM,CACN,EAAS,CAAE,YAAa,EAAM,WAAY,CAAE,OAAQ,MAAO,EAAG,cAAe,CAAC,CAAE,CAClF,CAEA,IAAM,EAA6B,CAAC,EAEhC,EAAO,aAAa,EAAE,mBAAmB,CAC3C,EAAY,kBAAkB,CAAG,EAAO,aAAa,CAAC,iBAAA,AAAiB,EAErE,EAAO,aAAa,EAAE,YAAY,CACpC,EAAY,UAAU,CAAG,EAAO,aAAa,CAAC,UAAA,AAAU,EAEtD,EAAO,aAAa,EAAE,UAAU,CAClC,EAAY,QAAQ,CAAG,EAAO,aAAa,CAAC,QAAA,AAAQ,EAElD,EAAO,aAAa,EAAE,kBAAkB,AAC1C,GAAY,iBAAiB,CAAG,OAAO,EAAO,aAAa,CAAC,iBAAgB,EAE1E,EAAO,kBAAkB,EAAE,CAC7B,EAAY,KAAK,CAAG,CAAA,EAAG,EAAK,KAAK,EAAI,GAAG;AAAA,uBAAyB,EAAE,EAAO,kBAAkB,CAAA,CAAE,CAAC,IAAI,GACnG,EAAY,YAAY,CAAG,OAAO,EAAO,kBAAkB,GAG7D,GAAI,CACF,GAAM,WAAE,CAAS,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAEtB,EAAY,KAAK,CADP,EAAU,AACA,EADM,GAE1B,EAAY,gBAAgB,CAAG,IAAI,OAAO,WAAW,EACvD,CAAE,KAAM,CAAC,CAGL,EAAO,aAAa,EAAI,EAAO,gBAAgB,CACjD,CADmD,CACxC,iBACF,EAAO,eAAe,EAAgC,cAAc,CAA1C,EAAK,kBAAkB,CAC1D,EAAW,aACF,EAAO,cAAc,EAAE,CAChC,EAAW,EAAO,cAAA,AAAc,EAG9B,EAAO,aAAa,EAAE,cAAc,CACtC,EAAY,aAAa,CAAG,OAAO,EAAO,aAAa,CAAC,aAAY,EAGtE,IAAM,EAA+B,EAAO,UAAU,EAAI,CAAE,OAAQ,MAAO,CAEvE,EAAC,EAAO,eAAe,EAAI,EAAO,gBAAA,AAAgB,GAAK,EAAK,GAAG,EAAI,EAAK,eAAe,EAAE,CAC3F,EAAY,YAAY,CAzNrB,AAyNwB,SAzNF,AAAb,CAAwB,CAAE,CAAe,CAAE,CAAW,CAAE,EAAa,EAAG,EAGtF,OAAO,KAAK,GAAG,CAAC,EAAG,KAAK,KAAK,CAAC,AADlB,EAAM,EAAa,EAAU,GAE3C,EAqN4C,EAAK,GAAG,CAAE,EAAK,eAAe,CAAE,EAAO,eAAe,CAAE,EAAO,eAAc,EAGvH,GAAI,CACF,GAAM,CAAE,cAAY,CAAE,KAAG,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OACxB,EAAO,EAAI,EAAK,GAAG,EAAI,EAAG,EAAK,eAAe,EAAI,EAAG,EAAO,eAAe,CAAE,EAAO,cAAc,EAClG,EAAI,EAAa,EAAM,EAAM,EAAY,YAAY,OAAI,EAC3D,EAAC,EAAE,OAAO,EAAI,EAAE,UAAU,GAAE,EAAY,YAAY,CAAG,EAAE,UAAA,AAAU,CACzE,CAAE,KAAM,CAAC,CAET,MAAO,CACL,QAAS,EAAO,WAAW,aAC3B,WACA,EACA,UAAW,UACX,UAAW,aACX,CACF,CACF,CAEO,eAAe,EAAwB,CAAU,CAAE,CAAmB,EAC3E,MAAO,CAAC,GAAG,EAAE,EAAK,IAAI,CAAC,UAAU,EAAE,EAAO,YAAY,CAAC,sCAAsC,EAAE,EAAK,OAAO,CAAC,wFAAwF,CAAC,AACvM,CAEO,eAAe,EAAiB,CAAU,CAAE,CAAmB,EACpE,OAAQ,EAAK,kBAAkB,EAC7B,IAAK,YACH,MAAO,CAAC,GAAG,EAAE,EAAK,IAAI,CAAC,wCAAwC,EAAE,EAAK,OAAO,CAAC,gGAAgG,CAAC,AACjL,KAAK,aACH,MAAO,CAAC,GAAG,EAAE,EAAK,IAAI,CAAC,8DAA8D,EAAE,EAAK,YAAY,EAAE,iBAAiB,KAAK,EAAE,EAAK,OAAO,CAAC,4BAA4B,CAAC,AAC9K,KAAK,gBACH,MAAO,CAAC,GAAG,EAAE,EAAK,IAAI,CAAC,+DAA+D,EAAE,EAAK,OAAO,CAAC,wCAAwC,CAC/I,AADgJ,SAE9I,MAAO,CAAC,GAAG,EAAE,EAAK,IAAI,CAAC,UAAU,EAAE,EAAO,YAAY,CAAC,oBAAoB,EAAE,EAAK,OAAO,CAAC,yDAAyD,CAAC,AACxJ,CACF,+JC3fA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,oBAEA,IAAM,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAwC,QAAQ,GAAG,CAAC,yBAAyB,CAAG,CACjH,QAAS,CACP,OAAQ,SAAY,CAAC,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,CAAE,CAAE,MAAM,GAC5C,OAAQ,MAAO,IACb,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IACjC,EAAa,OAAO,CAAC,CAAC,MAAE,CAAI,OAAE,CAAK,SAAE,CAAO,CAAE,IAC5C,EAAY,GAAG,CAAC,EAAM,EAAO,EAC/B,EACF,CACF,CACF,GAmBO,eAAe,EAAW,CAAc,CAAE,CAAgC,EAC/E,GAAI,CACF,GAAM,CAAE,MAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,SAAS,MAAM,CAAC,CAC1D,QAAS,EACT,UAAW,EACX,YAAa,SACf,GAEA,GAAI,EAEF,KAFS,EACT,QAAQ,KAAK,CAAC,8BAA+B,GACtC,KAGT,OAAO,EAAO,CAAI,CAAC,EAAE,CAAG,IAC1B,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kCAAmC,GAC1C,IACT,CACF,CAEO,eAAe,EAAW,CAAc,CAAE,CAA2B,EAC1E,GAAI,CACF,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,SAAS,MAAM,CAAC,GAAS,EAAE,CAAC,KAAM,GAAQ,MAAM,GAE5F,GAAI,EAEF,KAFS,EACT,QAAQ,KAAK,CAAC,8BAA+B,GACtC,KAGT,OAAO,EAAO,CAAI,CAAC,EAAE,CAAG,IAC1B,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kCAAmC,GAC1C,IACT,CACF,CAEO,eAAe,EAAe,CAAc,EACjD,GAAI,CACF,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,UAAW,GACd,KAAK,CAAC,aAAc,CAAE,UAAW,EAAM,GAE1C,GAAI,EAEF,KAFS,EACT,QAAQ,KAAK,CAAC,2BAA4B,GACnC,EAAE,CAGX,OAAO,GAAQ,EAAE,AACnB,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kCAAmC,GAC1C,EAAE,AACX,CACF,CAEO,eAAe,EAAa,CAAc,CAAE,CAAiB,CAAE,CAAc,EAClF,GAAI,CACF,MAAM,EAAS,IAAI,CAAC,eAAe,MAAM,CAAC,CACxC,QAAS,EACT,WAAY,EACZ,WAAY,CACd,EACF,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,uBAAwB,EACxC,CACF,CAEO,eAAe,EAAY,CAAc,EAC9C,GAAI,CACF,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,SAAS,MAAM,CAAC,KAAK,EAAE,CAAC,KAAM,GAAQ,MAAM,GACxF,GAAI,GAAS,CAAC,EAAM,OAAO,KAC3B,OAAO,CACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,iCAAkC,GACzC,IACT,CACF,CAEO,eAAe,EACpB,CAAc,CACd,CAAwB,CACxB,CAAsB,EAEtB,GAAI,CAEF,IAAM,EAAO,MAAM,EAAW,EAAQ,YAEtC,GAAI,CAAC,EAAM,YACT,QAAQ,KAAK,CAAC,CAAC,oDAAoD,EAAE,EAAA,CAAQ,EAe/E,GAVA,MAAM,EAAa,EAAK,EAAE,CAAE,uBAAwB,CAClD,cAAe,EACf,eAAgB,EAChB,aAAc,IAAI,OAAO,WAAW,EACtC,GAEA,QAAQ,GAAG,CAAC,CAAC,gCAAgC,EAAE,EAAK,EAAE,CAAC,WAAW,EAAE,EAAO,UAAU,EAAE,EAAA,CAAkB,EAIrG,EACF,MAAM,EAAa,EAAK,EAAE,CADT,AACW,iBAAkB,CAC5C,eAAgB,CAClB,QACK,GAAyB,wBAArB,GAAmE,wBAAwB,CAA7C,EAEvD,GAAI,CACF,IAAM,EAAW,MAAM,MACrB,CAAA,EAAG,QAAQ,GAAG,CAAC,mBAAmB,EAAI,wBAAwB,0BAA0B,CAAC,CACzF,CACE,OAAQ,OACR,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,SAAS,CAAC,QACnB,mBACA,CACF,EACF,EAGE,CAAC,EAAS,EAAE,EAAE,AAChB,QAAQ,KAAK,CAAC,CAAC,sCAAsC,CAAC,CAAE,MAAM,EAAS,IAAI,GAE/E,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,CAAC,4CAA4C,CAAC,CAAE,EAChE,CAEJ,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,CAAC,kDAAkD,EAAE,EAAO,CAAC,CAAC,CAAE,EAChF,CACF,iCAvIsB,EAoBA,EAgBA,EAoBA,EAYA,EAWA,IA/EA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAoBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAgBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAoBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAYA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAWA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,6ICjHtB,IAAA,EAAA,EAAA,CAAA,CAAA,OCAO,IAAM,EAAc,CACzB,CAAE,OAAQ,cAAe,SAAU,8BAA+B,SAAU,6KAA8K,EAC1P,CAAE,OAAQ,cAAe,SAAU,kCAAmC,SAAU,0FAA2F,EAC3K,CAAE,OAAQ,eAAgB,SAAU,2BAA4B,SAAU,qGAAsG,EAChL,CAAE,OAAQ,cAAe,SAAU,0BAA2B,SAAU,wFAAyF,EACjK,CAAE,OAAQ,cAAe,SAAU,mCAAoC,SAAU,kHAAmH,EACpM,CAAE,OAAQ,cAAe,SAAU,wBAAyB,SAAU,yIAA0I,EAChN,CAAE,OAAQ,cAAe,SAAU,0BAA2B,SAAU,8HAA+H,EACvM,CAAE,OAAQ,eAAgB,SAAU,uCAAwC,SAAU,6GAA8G,EACpM,CAAE,OAAQ,WAAY,SAAU,0BAA2B,SAAU,qFAAsF,EAC3J,CAAE,OAAQ,cAAe,SAAU,wBAAyB,SAAU,kFAAmF,EACzJ,CAAE,OAAQ,cAAe,SAAU,+BAAgC,SAAU,4GAA6G,EAC1L,CAAE,OAAQ,cAAe,SAAU,4CAA6C,SAAU,8FAA+F,EACzL,CAAE,OAAQ,YAAa,SAAU,wBAAyB,SAAU,8GAA+G,EACnL,CAAE,OAAQ,cAAe,SAAU,iCAAkC,SAAU,wGAAyG,EACxL,CAAE,OAAQ,cAAe,SAAU,oBAAqB,SAAU,yDAA0D,EAC5H,CAAE,OAAQ,cAAe,SAAU,2BAA4B,SAAU,4FAA6F,EACtK,CAAE,OAAQ,cAAe,SAAU,mBAAoB,SAAU,oEAAqE,EACtI,CAAE,OAAQ,cAAe,SAAU,oCAAqC,SAAU,+FAAgG,EAClL,CAAE,OAAQ,cAAe,SAAU,yBAA0B,SAAU,gFAAiF,EACxJ,CAAE,OAAQ,cAAe,SAAU,0CAA2C,SAAU,4DAA6D,EACrJ,CAAE,OAAQ,cAAe,SAAU,0BAA2B,SAAU,iFAAkF,EAC1J,CAAE,OAAQ,cAAe,SAAU,4BAA6B,SAAU,gFAAiF,EAC3J,CAAE,OAAQ,cAAe,SAAU,qCAAsC,SAAU,0FAA2F,EAC9K,CAAE,OAAQ,WAAY,SAAU,6BAA8B,SAAU,oFAAqF,EAC7J,CAAE,OAAQ,eAAgB,SAAU,gCAAiC,SAAU,+EAAgF,EAC/J,CAAE,OAAQ,cAAe,SAAU,sBAAuB,SAAU,oEAAqE,EACzI,CAAE,OAAQ,cAAe,SAAU,qBAAsB,SAAU,yFAA0F,EAC7J,CAAE,OAAQ,cAAe,SAAU,qCAAsC,SAAU,4FAA6F,EAChL,CAAE,OAAQ,cAAe,SAAU,gCAAiC,SAAU,4EAA6E,EAC3J,CAAE,OAAQ,cAAe,SAAU,2BAA4B,SAAU,oDAAqD,EAC9H,CAAE,OAAQ,YAAa,SAAU,2BAA4B,SAAU,mGAAoG,EAC3K,CAAE,OAAQ,WAAY,SAAU,6BAA8B,SAAU,8EAA+E,EACvJ,CAAE,OAAQ,cAAe,SAAU,0BAA2B,SAAU,0EAA2E,EACnJ,CAAE,OAAQ,cAAe,SAAU,yBAA0B,SAAU,8FAA+F,EACtK,CAAE,OAAQ,cAAe,SAAU,iCAAkC,SAAU,yDAA0D,EACzI,CAAE,OAAQ,cAAe,SAAU,mCAAoC,SAAU,kFAAmF,EACpK,CAAE,OAAQ,cAAe,SAAU,6BAA8B,SAAU,0DAA2D,EACvI,CDxBM,SAAS,EAAkB,CAAW,EAC3C,OAAO,EAAI,WAAW,GAAG,OAAO,CAAC,WAAY,IAAI,OAAO,CAAC,OAAQ,KAAK,IAAI,EAC5E,CAEO,SAAS,EAAe,CAAW,EACxC,IAAM,EAAI,EAAI,WAAW,GACnB,EAAM,CAAC,GAAG,IAAoB,EAAM,IAAI,CAAC,AAAC,GAAM,EAAE,QAAQ,CAAC,WACjE,AAAI,EAAI,WAAY,eAAgB,UAAW,WAAY,QAAS,UAAW,QAAS,aAAc,YAAa,WAAY,QAAS,aAAqB,CAAP,aAClJ,EAAI,MAAO,OAAQ,aAAc,cAAe,QAAS,gBAAiB,kBAA0B,CAAP,UAC7F,EAAI,OAAQ,aAAc,QAAS,cAAe,UAAW,eAAgB,cAAsB,CAAP,WAC5F,EAAI,WAAY,aAAc,gBAAiB,SAAU,eAAgB,aAAc,oBAAqB,UAAW,QAAS,WAAY,WAAmB,CAAP,cACxJ,EAAI,UAAW,WAAY,QAAS,YAAa,UAAW,QAAS,UAAW,SAAU,UAAW,UAAW,cAAe,QAAS,SAAU,aAAc,uBAA+B,CAAP,aACxL,EAAI,UAAW,SAAU,MAAO,OAAQ,SAAiB,CAAP,mBAClD,EAAI,QAAS,aAAc,UAAW,UAAW,UAAkB,CAAP,aAC5D,EAAI,SAAU,SAAU,YAAa,cAAe,sBAA8B,CAAP,WACxE,SACT,CAEO,eAAe,EAAa,CAAc,CAAE,CAAa,EAC9D,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CAAE,KAAM,CAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,oBACL,MAAM,CAAC,oBACP,EAAE,CAAC,SAAU,GACb,EAAE,CAAC,sBAAuB,GAC1B,KAAK,CAAC,GACN,WAAW,GACd,GAAI,GAAO,cAET,CAFwB,MACxB,MAAM,EAAS,IAAI,CAAC,eAAe,MAAM,CAAC,CAAE,mBAAoB,EAAM,EAAE,CAAE,aAAc,EAAO,mBAAoB,CAAI,GAChH,CAAE,KAAM,EAAM,aAAa,CAAE,WAAY,CAAI,EAEtD,GAAM,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC7B,IAAI,CAAC,oBACL,MAAM,CAAC,wCACP,EAAE,CAAC,SAAU,GACb,KAAK,CAAC,GACH,EAAI,CAAC,GAAW,EAAA,AAAE,EAAE,IAAI,CAAC,AAAC,GAAW,OAAO,EAAE,mBAAmB,EAAI,IAAI,QAAQ,CAAC,EAAM,KAAK,CAAC,KAAK,KAAK,CAAC,EAAG,GAAG,IAAI,CAAC,OAC1H,GAAI,GAAG,cAEL,CAFoB,MACpB,MAAM,EAAS,IAAI,CAAC,eAAe,MAAM,CAAC,CAAE,mBAAoB,EAAE,EAAE,CAAE,aAAc,EAAO,mBAAoB,GAAK,GAC7G,CAAE,KAAM,EAAE,aAAa,CAAE,WAAY,GAAK,CAErD,CAAE,KAAM,CAAC,CACT,IAAM,EAAO,AAAC,GAAc,EAAE,WAAW,GAAG,OAAO,CAAC,WAAY,IAAI,OAAO,CAAC,OAAQ,KAAK,IAAI,GACvF,EAAa,EAAY,IAAI,CAAC,AAAC,GAAM,EAAE,MAAM,GAAK,GAAU,EAAK,EAAE,QAAQ,IAAM,GACvF,GAAI,EAAY,MAAO,CAAE,KAAM,EAAW,QAAQ,CAAE,WAAY,GAAK,EACrE,IAAM,EAAe,EAAY,IAAI,CAAC,AAAC,GAAM,EAAE,MAAM,GAAK,GAAU,EAAK,EAAE,QAAQ,EAAE,QAAQ,CAAC,EAAM,KAAK,CAAC,KAAK,KAAK,CAAC,EAAG,GAAG,IAAI,CAAC,cAChI,AAAI,EAAqB,CAAE,KAAM,EAAa,IAA5B,IAAoC,CAAE,WAAY,EAAI,EACjE,CAAE,KAAM,KAAM,WAAY,CAAE,CACrC,CAEO,eAAe,EAAY,CAAc,CAAE,CAAa,CAAE,CAAY,EAC3E,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,GACnC,OAAM,EACH,IAAI,CAAC,oBACL,MAAM,CAAC,QAAE,EAAQ,oBAAqB,EAAO,cAAe,EAAM,WAAY,IAAI,OAAO,WAAW,EAAG,EAAG,CAAE,WAAY,4BAA6B,EAC1J,gIEtEA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OASO,eAAe,EAAc,CAAyE,EAC3G,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,GACnC,OAAM,EAAS,IAAI,CAAC,YAAY,MAAM,CAAC,CACrC,YAAa,OACb,UAAW,EAAK,EAAE,CAClB,MAAO,OACP,QAAS,WACT,KAAM,CAAE,KAAM,EAAK,IAAI,CAAE,MAAO,EAAK,YAAY,CAAE,QAAS,EAAK,OAAO,AAAC,CAC3E,EACF,CAAE,KAAM,CAAC,CAET,IAAM,EAAO,CAAC,UAAU,EAAE,EAAK,IAAI,CAAC;AAAE,EAAE,EAAK,OAAO,CAAC;AAAA,OAAS,EAAE,EAAK,YAAY,CAAA,CAAE,CAGnF,GAAI,CACF,QAAM,EAAa,QAAQ,GAAG,CAAC,kBAAkB,CAC3C,EAAa,QAAQ,GAAG,CAAC,mBAAmB,CAC5C,GAxBF,EAAM,IAwBK,IAxBG,GAAG,CAAC,kBAAkB,CACpC,EAAQ,QAAQ,GAAG,CAAC,iBAAiB,CACvC,AAAC,AAAL,GAAa,EACN,CAAA,CADK,CACL,EAAA,AADa,OACb,AAAM,EAAC,EAAK,GADQ,MAuBrB,GAAU,GAAc,GAC1B,MAAM,EAAO,CADyB,OACjB,CAAC,MAAM,CAAC,CAAE,GAAI,EAAY,KAAM,EAAY,KAAM,CAAK,EAEhF,CAAE,KAAM,CAAC,CAGT,GAAI,CACF,IAAM,EAAQ,QAAQ,GAAG,CAAC,kBAAkB,CACtC,EAAS,QAAQ,GAAG,CAAC,gBAAgB,CACvC,GAAS,GACX,KADmB,CACb,MAAM,CAAC,4BAA4B,EAAE,EAAM,YAAY,CAAC,CAAE,CAC9D,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,CAAE,QAAS,EAAQ,MAAK,EAC/C,EAEJ,CAAE,KAAM,CAAC,CACX,sDC9CA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAOA,SAAS,EAAK,CAAW,EACvB,OAAO,KAAK,IAAI,CAAC,EAAE,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAI,EAAG,GACjD,CAQO,eAAe,EAAW,CAAY,EAC3C,IAAM,EAAS,IAAI,EAAA,OAAM,CAAC,CAAE,OAAQ,QAAQ,GAAG,CAAC,cAAc,AAAE,GAEhE,MADY,AACL,OADW,EAAO,UAAU,CAAC,MAAM,CAAC,CAAE,MAAO,yBAA0B,MAAO,CAAK,EAAA,EAC/E,IAAI,CAAC,EAAE,CAAC,SAAS,AAC9B,CAEO,eAAe,EACpB,CAAc,CACd,CAAa,CACb,CAAe,CACf,EAAgB,GAAI,CACpB,CAAgB,EAEhB,IAAM,EAAM,CAAA,EAAA,EAAA,mBAAA,AAAmB,IACzB,EAAM,MAAM,EAAW,GACzB,EAAI,EAAI,IAAI,CAAC,oBAAoB,MAAM,CAAC,mEAAmE,EAAE,CAAC,SAAU,GACxH,GAAQ,GAAI,EAAE,EAAE,CAAC,SAAU,EAAA,EAC/B,GAAM,MAAE,CAAI,CAAE,CAAG,MAAM,EAAE,KAAK,CAAC,KACzB,EAAM,KAAK,GAAG,GACd,EAA8B,UAAnB,OAAO,GAAwB,EAAU,EAAI,AAAU,KAAK,KAAK,KAAK,AAAO,EAMxF,EALW,AAKF,CALG,GAAQ,EAAA,AAAE,EAAE,MAAM,CAAE,AAAD,GACnC,CAAK,GAAD,AAEG,EADS,IAAI,AACP,CAFE,IACU,EAAI,CADP,SACiB,EAAE,OAAO,IACxB,GAEF,GAAG,CAAE,AAAD,MAAc,kBAAC,CAAE,GAAI,EAAI,EAAE,CAAE,KAAM,EAAI,aAAa,CAAY,KAAA,EAhCjE,AAgCwE,CAhC7D,CAgC0E,EAAI,SAAS,EAAY,EAAE,CA/BrI,EAAK,EA+B+F,GA/B1F,AACV,EAAK,EAAK,GACZ,AAAC,AAAL,GAAY,EAXd,AAYS,CADI,CAAK,EACL,KAZJ,AAAI,CAAW,CAAE,CAAW,EACnC,IAAI,EAAI,EACR,IAAK,IAAI,EAAI,EAAG,EAAI,KAAK,GAAG,CAAC,EAAE,MAAM,CAAE,EAAE,MAAM,EAAG,IAAK,GAAK,CAAC,CAAC,EAAE,CAAG,CAAC,CAAC,EAAE,CACvE,OAAO,CACT,IAQgB,IAAM,CAAD,CAAM,CAAA,CAAE,CADJ,EA6BsH,CAAC,GAC9I,EAAO,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EACvC,IAAM,EAAO,CAAM,CAAC,EAAE,CACtB,GAAI,GAAQ,EAAK,KAAK,EAAI,EAAO,CAC/B,IAAM,EAAU,CAAC,GAAQ,EAAE,AAAF,EAAI,IAAI,CAAC,AAAC,GAAW,EAAE,EAAE,GAAK,EAAK,EAAE,EAK9D,OAJA,MAAM,EACH,IAAI,CAAC,oBACL,MAAM,CAAC,CAAE,YAAa,CAAE,GAAS,cAA0B,CAAC,CAAI,EAAG,aAAc,IAAI,OAAO,WAAW,EAAG,GAC1G,EAAE,CAAC,KAAM,EAAK,EAAE,EACZ,CAAE,KAAM,EAAK,IAAI,CAAE,WAAY,EAAK,KAAK,CAAE,GAAI,EAAK,EAAE,AAAC,CAChE,CACA,MAAO,CAAE,KAAM,KAAM,WAAY,CAAE,CACrC","ignoreList":[2,3,4]}