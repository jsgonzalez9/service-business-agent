{"version":3,"sources":["../../../lib/supabase/service.ts","../../../lib/llm-cache.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\"\n\nexport function createServiceClient() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY!\n  return createClient(url, key)\n}\n\n","import OpenAI from \"openai\"\nimport { createServiceClient } from \"@/lib/supabase/service\"\n\nfunction dot(a: number[], b: number[]) {\n  let s = 0\n  for (let i = 0; i < Math.min(a.length, b.length); i++) s += a[i] * b[i]\n  return s\n}\nfunction norm(a: number[]) {\n  return Math.sqrt(a.reduce((s, v) => s + v * v, 0))\n}\nfunction cosine(a: number[], b: number[]) {\n  const na = norm(a)\n  const nb = norm(b)\n  if (!na || !nb) return 0\n  return dot(a, b) / (na * nb)\n}\n\nexport async function embedQuery(text: string): Promise<number[]> {\n  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! })\n  const emb = await openai.embeddings.create({ model: \"text-embedding-3-small\", input: text })\n  return emb.data[0].embedding as unknown as number[]\n}\n\nexport async function findCachedByEmbedding(\n  intent: string,\n  query: string,\n  market?: string,\n  floor: number = 0.85,\n  ttlDays?: number,\n): Promise<{ text: string | null; confidence: number; id?: string }> {\n  const svc = createServiceClient()\n  const vec = await embedQuery(query)\n  let q = svc.from(\"cached_responses\").select(\"id,response_text,embedding,intent,market,usage_count,created_at\").eq(\"intent\", intent)\n  if (market) q = q.eq(\"market\", market)\n  const { data } = await q.limit(200)\n  const now = Date.now()\n  const maxAgeMs = typeof ttlDays === \"number\" && ttlDays > 0 ? ttlDays * 24 * 60 * 60 * 1000 : undefined\n  const filtered = (data || []).filter((row: any) => {\n    if (!maxAgeMs) return true\n    const created = new Date(row.created_at).getTime()\n    return now - created <= maxAgeMs\n  })\n  const scored = filtered.map((row: any) => ({ id: row.id, text: row.response_text as string, score: cosine(vec, (row.embedding as any) || []) }))\n  scored.sort((a, b) => b.score - a.score)\n  const best = scored[0]\n  if (best && best.score >= floor) {\n    const current = (data || []).find((d: any) => d.id === best.id)\n    await svc\n      .from(\"cached_responses\")\n      .update({ usage_count: ((current?.usage_count as number) || 0) + 1, last_used_at: new Date().toISOString() })\n      .eq(\"id\", best.id)\n    return { text: best.text, confidence: best.score, id: best.id }\n  }\n  return { text: null, confidence: 0 }\n}\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEO,SAAS,IAEd,IAAM,EAAM,QAAQ,GAAG,CAAC,yBAAyB,CACjD,MAAO,CAAA,EAAA,EAAA,YAAY,AAAZ,EAFD,AAEc,2CAAK,EAC3B,4DCNA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAOA,SAAS,EAAK,CAAW,EACvB,OAAO,KAAK,IAAI,CAAC,EAAE,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAI,EAAG,GACjD,CAQO,eAAe,EAAW,CAAY,EAC3C,IAAM,EAAS,IAAI,EAAA,OAAM,CAAC,CAAE,OAAQ,QAAQ,GAAG,CAAC,cAAc,AAAE,GAEhE,MAAO,CADK,MAAM,EAAO,UAAU,CAAC,MAAM,CAAC,CAAE,MAAO,yBAA0B,MAAO,CAAK,EAAA,EAC/E,IAAI,CAAC,EAAE,CAAC,SAAS,AAC9B,CAEO,eAAe,EACpB,CAAc,CACd,CAAa,CACb,CAAe,CACf,EAAgB,GAAI,CACpB,CAAgB,EAEhB,IAAM,EAAM,CAAA,EAAA,EAAA,mBAAA,AAAmB,IACzB,EAAM,MAAM,EAAW,GACzB,EAAI,EAAI,IAAI,CAAC,oBAAoB,MAAM,CAAC,mEAAmE,EAAE,CAAC,SAAU,GACxH,IAAQ,EAAI,EAAE,EAAE,CAAC,SAAU,EAAA,EAC/B,GAAM,MAAE,CAAI,CAAE,CAAG,MAAM,EAAE,KAAK,CAAC,KACzB,EAAM,KAAK,GAAG,GACd,EAA8B,UAAnB,OAAO,GAAwB,EAAU,EAAc,KAAV,AAAe,KAAK,KAAK,AAAO,EAMxF,EALW,AAKF,CALG,GAAQ,EAAE,AAAF,EAAI,MAAM,CAAC,AAAC,GACpC,CAAK,GAAD,AAEG,EADS,IAAI,AACP,CAFE,IACU,EAAI,CADP,SACiB,EAAE,OAAO,IACxB,GAEF,GAAG,CAAC,AAAC,MAAa,kBAAC,CAAE,GAAI,EAAI,EAAE,CAAE,KAAM,EAAI,aAAa,CAAY,KAAA,EAhCjE,AAgCwE,CAhC7D,CAgC0E,EAAI,SAAS,EAAY,EAAE,CA/BrI,EAAK,EA+B+F,GA/B1F,AACV,EAAK,EAAK,GAChB,AAAI,AAAC,GAAO,EACL,AAZT,CAWa,CAAK,EACL,KAZJ,AAAI,CAAW,CAAE,CAAW,EACnC,IAAI,EAAI,EACR,IAAK,IAAI,EAAI,EAAG,EAAI,KAAK,GAAG,CAAC,EAAE,MAAM,CAAE,EAAE,MAAM,EAAG,IAAK,GAAK,CAAC,CAAC,EAAE,CAAG,CAAC,CAAC,EAAE,CACvE,OAAO,CACT,IAQgB,IAAM,CAAD,CAAM,CAAA,CAAE,CADJ,EA6BsH,CAAC,GAC9I,EAAO,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EACvC,IAAM,EAAO,CAAM,CAAC,EAAE,CACtB,GAAI,GAAQ,EAAK,KAAK,EAAI,EAAO,CAC/B,IAAM,EAAU,CAAC,GAAQ,EAAE,AAAF,EAAI,IAAI,CAAC,AAAC,GAAW,EAAE,EAAE,GAAK,EAAK,EAAE,EAK9D,OAJA,MAAM,EACH,IAAI,CAAC,oBACL,MAAM,CAAC,CAAE,YAAa,CAAE,GAAS,cAA0B,CAAC,CAAI,EAAG,aAAc,IAAI,OAAO,WAAW,EAAG,GAC1G,EAAE,CAAC,KAAM,EAAK,EAAE,EACZ,CAAE,KAAM,EAAK,IAAI,CAAE,WAAY,EAAK,KAAK,CAAE,GAAI,EAAK,EAAE,AAAC,CAChE,CACA,MAAO,CAAE,KAAM,KAAM,WAAY,CAAE,CACrC"}