module.exports=[38558,e=>{"use strict";var t=e.i(55454),n=e.i(78872),a=e.i(51045),o=e.i(17396),s=e.i(37276),i=e.i(63400),r=e.i(51826),l=e.i(52747),d=e.i(59428),c=e.i(81124),u=e.i(46569),p=e.i(21392),m=e.i(12613),_=e.i(2254),g=e.i(7707),h=e.i(55431),w=e.i(93695);e.i(33109);var f=e.i(30833),R=e.i(61760),y=e.i(54233),v=e.i(16303),b=e.i(32721),x=e.i(76296),S=e.i(84359),C=e.i(89660),T=e.i(84204),E=e.i(15794);async function A(e){try{let t,n,a=await e.formData(),o=a.get("From"),s=a.get("Body"),i=a.get("MessageSid");if(console.log(`[Incoming SMS] From: ${o}, Message: ${s}`),!o||!s)return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});try{let e=await (0,C.createClient)(),t=new Date(Date.now()-2592e6).toISOString(),{data:n}=await e.from("buyer_broadcasts").select("*").eq("to_phone",o).gte("sent_at",t).order("sent_at",{ascending:!1}).limit(1),a=(n||[])[0];if(a&&a.lead_id){let t=s.match(/\$?\s*([0-9]{2,3}(?:[,][0-9]{3})*(?:\.[0-9]{2})?)/),n=/\b(yes|interested|i'm in|count me in)\b/i.test(s),i=t?Number(String(t[1]).replace(/,/g,"")):null,{data:r}=await e.from("leads").select("offers_received,best_assignment_fee").eq("id",a.lead_id).single(),l={offers_received:(r?.offers_received||0)+1};return i&&(!r?.best_assignment_fee||i>Number(r.best_assignment_fee))&&(l.best_assignment_fee=i),await e.from("leads").update(l).eq("id",a.lead_id),await e.from("buyer_offers").insert({lead_id:a.lead_id,buyer_id:a.buyer_id||null,from_phone:o,amount:i,notes:n?"interested":null}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}}catch{}let r=await (0,y.getLeadByPhone)(o);if(!r)return console.log(`No lead found for phone: ${o}`),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});if("contract_signed"===r.conversation_state||"closed"===r.conversation_state)return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});await (0,y.saveMessage)({lead_id:r.id,direction:"inbound",content:s,twilio_sid:i});let l=s.trim().toLowerCase(),d="stop"===l||l.includes("unsubscribe")||l.includes("cancel")||"end"===l||"quit"===l||l.includes("stop all")||l.includes("do not text"),c="start"===l||"yes"===l||"y"===l||l.includes("unstop")||l.includes("subscribe");if(d){await (0,y.updateLead)(r.id,{is_opted_out:!0,opted_out_at:new Date().toISOString(),optout_reason:"keyword"}),await (0,y.saveMessage)({lead_id:r.id,direction:"outbound",content:"You’ve been unsubscribed — no more messages."});let{error:e}=await (0,b.sendSMS)(r.phone_number,"You’ve been unsubscribed — no more messages.",{withFooter:!1,bypassSuppression:!0});try{let e=await (0,C.createClient)();await e.from("consents").insert({lead_id:r.id,phone_number:r.phone_number,event:"opt_out",source:"keyword",message_sid:i})}catch{}return e&&console.error("Failed to send opt-out confirmation:",e),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}if(c){await (0,y.updateLead)(r.id,{is_opted_out:!1,optout_reason:null,consent_status:"opt_in",consented_at:new Date().toISOString(),consent_source:"keyword"});try{let e=await (0,C.createClient)();await e.from("consents").insert({lead_id:r.id,phone_number:r.phone_number,event:"opt_in",source:"keyword",message_sid:i})}catch{}return await (0,y.saveMessage)({lead_id:r.id,direction:"outbound",content:"Thanks for confirming — we’ll text you about your property. Reply STOP to unsubscribe."}),await (0,b.sendSMS)(r.phone_number,"Thanks for confirming — we'll text you about your property. Reply STOP to unsubscribe.",{withFooter:!1,bypassSuppression:!0}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}if("help"===l||l.includes("help"))return await (0,y.saveMessage)({lead_id:r.id,direction:"outbound",content:"Help: We send messages about property offers. Msg&Data rates may apply. Reply STOP to unsubscribe. For support, reply here."}),await (0,b.sendSMS)(r.phone_number,"Help: We send messages about property offers. Reply STOP to unsubscribe.",{withFooter:!1,bypassSuppression:!0}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});if(["not interested","stop contacting me","wrong number","nla","remove me","sold already","do not contact","no longer available","not selling","leave me alone"].some(e=>l.includes(e)))return await (0,y.updateLead)(r.id,{pipeline_status:"DEAD",score:0,tags:Array.from(new Set([...r.tags||[],"dead"]))}),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}});("cold_lead"===r.conversation_state||"contacted"===r.conversation_state)&&(await (0,y.updateLead)(r.id,{conversation_state:"contacted"}),r.conversation_state="contacted");let u=await (0,v.getAgentConfig)(),p=(0,T.classifyIntent)(s),m=null;if(!1!==u.llm_cache_enabled&&p.startsWith("FAQ")){let e=(0,T.normalizeQuestion)(s),{text:t,confidence:n}=await (0,T.lookupCached)(p,e);if(t&&n>=.85)m=t;else{let e="number"==typeof u.llm_cache_confidence_floor?u.llm_cache_confidence_floor:.85,t=p.startsWith("FAQ")?u.llm_cache_ttl_faq_days??30:u.llm_cache_ttl_objection_days??14,n=r.state||void 0,a=u.llm_cache_market_overrides||{};n&&a[n]&&(e=a[n].confidence_floor??e,t=p.startsWith("FAQ")?a[n].ttl_faq_days??t:a[n].ttl_objection_days??t);let o=await (0,E.findCachedByEmbedding)(p,s,n,e,t);o.text&&o.confidence>=.85&&(m=o.text)}}let _=m?{message:m,modelUsed:null,escalated:!1,updatedLead:{},newState:null,callIntent:null}:await (0,v.generateAgentResponse)(r,s,u);console.log(`[AI Response] Model: ${_.modelUsed}, Escalated: ${_.escalated}`),Object.keys(_.updatedLead).length>0&&await (0,y.updateLead)(r.id,_.updatedLead);let g=(t=s.toLowerCase(),n=new Set,(t.includes("vacant")||t.includes("no one living")||t.includes("empty"))&&n.add("vacant"),(t.includes("absentee")||t.includes("out of state")||t.includes("live elsewhere"))&&n.add("absentee"),(t.includes("preforeclosure")||t.includes("behind on payments")||t.includes("foreclosure"))&&n.add("preforeclosure"),(t.includes("tenant issues")||t.includes("late rent")||t.includes("landlord")||t.includes("tired landlord"))&&n.add("tired landlord"),Array.from(n));if(g.length>0&&await (0,y.updateLead)(r.id,{tags:Array.from(new Set([...r.tags||[],...g]))}),_.newState&&await (0,y.updateLead)(r.id,{conversation_state:_.newState}),_.callIntent?.action==="update_lead_status"&&_.callIntent?.lead_status&&(console.log(`[Call Intent Detected] Lead: ${r.id}, Status: ${_.callIntent.lead_status}, Time: ${_.callIntent.call_time||"immediate"}`),await (0,y.updateLead)(r.id,{conversation_state:_.callIntent.lead_status}),"text_only"!==_.callIntent.lead_status))try{await (0,x.triggerVoiceCall)(r.id,_.callIntent.lead_status,_.callIntent.call_time),console.log(`[Voice Call Triggered] for lead: ${r.id}`)}catch(e){console.error(`[Voice Call Error] Failed to trigger call for lead ${r.id}:`,e)}let h=new Set(["offer_made","offer_accepted","contract_sent","ready_for_offer_call","warm_call_requested","schedule_call"]);if((_.escalated||_.newState&&h.has(_.newState)||_.callIntent?.lead_status&&h.has(_.callIntent.lead_status))&&(await (0,y.updateLead)(r.id,{pipeline_status:"HOT",score:5}),await (0,S.notifyHotLead)({id:r.id,name:r.name,phone_number:r.phone_number,address:r.address})),!m&&p.startsWith("FAQ")){let e=(0,T.normalizeQuestion)(s);await (0,T.storeCached)(p,e,_.message)}let{sid:w,error:f}=await (0,b.sendSMS)(o,_.message);f&&console.error("Failed to send SMS:",f);let A="gpt-5.1"===_.modelUsed?"gpt-5":_.modelUsed;await (0,y.saveMessage)({lead_id:r.id,direction:"outbound",content:_.message,twilio_sid:w||void 0,model_used:m?null:A||null,was_escalated:_.escalated});try{let e=await (0,C.createClient)();await e.from("message_metrics").insert({lead_id:r.id,model:_.modelUsed||null,tokens:null,cost:null,confidence:m?1:.75})}catch{}return new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}catch(e){return console.error("Error processing incoming SMS:",e),new R.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{headers:{"Content-Type":"text/xml"}})}}e.s(["POST",()=>A],93340);var N=e.i(93340);let I=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/twilio/incoming/route",pathname:"/api/twilio/incoming",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/twilio/incoming/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:M,workUnitAsyncStorage:F,serverHooks:O}=I;function U(){return(0,a.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:F})}async function P(e,t,a){I.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/twilio/incoming/route";R=R.replace(/\/index$/,"")||"/";let y=await I.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:b,nextConfig:x,parsedUrl:S,isDraftMode:C,prerenderManifest:T,routerServerContext:E,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,resolvedPathname:M,clientReferenceManifest:F,serverActionsManifest:O}=y,U=(0,l.normalizeAppPath)(R),P=!!(T.dynamicRoutes[U]||T.routes[M]),k=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,S,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!T.routes[M],t=T.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await k();throw new w.NoFallbackError}}let D=null;!P||I.isDev||C||(D="/index"===(D=M)?"/":D);let L=!0===I.isDev||!P,q=P&&!L;O&&F&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:F,serverActionsManifest:O,serverModuleMap:(0,r.createServerModuleMap)({serverActionsManifest:O})});let H=e.method||"GET",$=(0,s.getTracer)(),j=$.getActiveScopeSpan(),B={params:b,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>I.onRequestError(e,t,a,E)},sharedContext:{buildId:v}},K=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),Q=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>I.handle(Q,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=$.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),r=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let d=async({previousCacheEntry:n})=>{try{if(!r&&A&&N&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(K,W,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},E),t}},c=await I.handleResponse({req:e,nextConfig:x,cacheKey:D,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:r});if(!P)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});r||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,_.fromNodeOutgoingHttpHeaders)(c.value.headers);return r&&P||u.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(K,W,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};j?await l(j):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})}),P)throw t;return await (0,m.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>U,"routeModule",()=>I,"serverHooks",()=>O,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>F],38558)}];

//# sourceMappingURL=479a2_next_dist_esm_build_templates_app-route_5875f6f3.js.map