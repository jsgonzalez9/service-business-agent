module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},89660,e=>{"use strict";e.i(94879);var t=e.i(87022),r=e.i(93458);async function n(){let e=await (0,r.cookies)();return(0,t.createServerClient)("http://localhost:54321","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvY2FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQwNjcyMDAsImV4cCI6MjAxOTY0MzIwMH0.local",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:n})=>e.set(t,r,n))}catch{}}}})}e.s(["createClient",()=>n])},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},32721,e=>{"use strict";var t=e.i(74461),r=e.i(89660);let n=process.env.TWILIO_ACCOUNT_SID,a=process.env.TWILIO_AUTH_TOKEN,s=process.env.TWILIO_PHONE_NUMBER,i=process.env.TWILIO_CALLER_ID,o=(process.env.TWILIO_NUMBER_POOL||"").split(",").map(e=>e.trim()).filter(e=>e.length>0),l=Number(process.env.SMS_MONTHLY_LIMIT_PER_NUMBER||1e4);async function d(){let e=o.length>0?o:s?[s]:[];if(0===e.length)return[];try{let t,n=await (0,r.createClient)(),{data:a}=await n.from("call_events").select("event_data, created_at").eq("event_type","sms_sent").gte("created_at",((t=new Date).setDate(1),t.setHours(0,0,0,0),t.toISOString())),s={};for(let e of a||[]){let t=e.event_data?.from;"string"==typeof t&&(s[t]=(s[t]||0)+1)}return e.filter(e=>(s[e]||0)<l).sort((e,t)=>(s[e]||0)-(s[t]||0))}catch{return e}}function u(){return n&&a?(0,t.default)(n,a):(console.warn("Twilio credentials not configured"),null)}function c(){if(i&&i.length>0)return i;let e=o.length>0?o:s?[s]:[];return e.length>0?e[0]:null}async function p(e,t,n){let a=u();if(!a){let r=n?.withFooter??!0?"\n\nReply STOP to unsubscribe":"",a=`${t}${r}`;return console.log(`[MOCK SMS] To: ${e}
Message: ${a}`),{sid:`mock_${Date.now()}`,error:null}}let s=Number(process.env.SMS_QUIET_HOURS_START||8),i=Number(process.env.SMS_QUIET_HOURS_END||21),o=new Date().getHours();if(o<s||o>=i)return{sid:null,error:"Quiet hours active; message not sent"};if(!n?.bypassSuppression)try{let t=await (0,r.createClient)(),n=e.replace(/\D/g,"");10===n.length?n=`+1${n}`:11===n.length&&n.startsWith("1")?n=`+${n}`:n.startsWith("+")||(n=`+${n}`);let{data:a}=await t.from("leads").select("*").eq("phone_number",n).single();if(a&&a.is_opted_out)return{sid:null,error:"Recipient has opted out"}}catch{}let l=await d();if(0===l.length)return{sid:null,error:"No available Twilio sender number (check pool or config)"};try{try{let e=await (0,r.createClient)(),t=new Date(Date.now()-6e4).toISOString(),{count:n}=await e.from("sms_events").select("id",{count:"exact",head:!0}).gte("created_at",t),a=Number(process.env.SMS_RATE_LIMIT_PER_MIN||25);if((n||0)>=a)return{sid:null,error:"Rate limit exceeded, try later"}}catch{}let s=[];try{let e=await (0,r.createClient)(),{data:t}=await e.from("agent_config").select("*").limit(1).single(),n=t?.company_name||"Your Company";s.push(`${n}: real estate lead generation`)}catch{s.push("Real estate lead generation")}s.push("Msg & data rates may apply"),s.push("Reply HELP for help"),s.push("Reply STOP to unsubscribe");let i=s.join(" â€¢ "),o=n?.withFooter??!0?`

${i}`:"",d=`${t}${o}`,u=null;for(let n of l)try{let s=await a.messages.create({body:d,from:n,to:e,statusCallback:"http://localhost:3000/api/twilio/status"});try{let a=await (0,r.createClient)();await a.from("sms_events").insert({sid:s.sid,to_number:e,from_number:n,status:"sent",error:null,body:t})}catch{}return{sid:s.sid,error:null}}catch(e){u=e?.message?String(e.message):"Failed to send SMS";continue}try{let n=await (0,r.createClient)();await n.from("sms_events").insert({sid:null,to_number:e,from_number:l[0],status:"failed",error:u||"Failed to send SMS",body:t})}catch{}return{sid:null,error:u||"Failed to send SMS"}}catch(e){return console.error("Error sending SMS:",e),{sid:null,error:e instanceof Error?e.message:"Failed to send SMS"}}}function _(e,r,n){return!a||t.default.validateRequest(a,e,r,n)}e.s(["chooseCallerId",()=>c,"eligibleNumbersSorted",()=>d,"getTwilioClient",()=>u,"sendSMS",()=>p,"validateTwilioRequest",()=>_])},81613,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),s=e.i(61916),i=e.i(14444),o=e.i(37092),l=e.i(69741),d=e.i(16795),u=e.i(87718),c=e.i(95169),p=e.i(47587),_=e.i(66012),m=e.i(70101),f=e.i(26937),h=e.i(10372),w=e.i(93695);e.i(52474);var g=e.i(5232),x=e.i(89171),v=e.i(89660),q=e.i(32721);async function S(){let e=await (0,v.createClient)(),t=new Date().toISOString(),r=!!process.env.TWILIO_ACCOUNT_SID&&!!process.env.TWILIO_AUTH_TOKEN&&(!!process.env.TWILIO_MESSAGING_SERVICE_SID||!!process.env.TWILIO_PHONE_NUMBER||!!process.env.TWILIO_NUMBER_POOL),n=!!process.env.TWILIO_ACCOUNT_SID&&!!process.env.TWILIO_AUTH_TOKEN&&(!!process.env.TWILIO_CALLER_ID||!!process.env.TWILIO_PHONE_NUMBER||!!process.env.TWILIO_NUMBER_POOL),{data:a}=await e.from("lead_sequences").select("*").eq("completed",!1).lte("next_run_at",t).limit(100);for(let t of a||[]){if(t.disabled)continue;let{data:a}=await e.from("leads").select("*").eq("id",t.lead_id).single();if(a&&(a.is_opted_out||"DEAD"===a.pipeline_status)){await e.from("lead_sequences").update({completed:!0,disabled:!0}).eq("id",t.id);continue}let{data:s}=await e.from("sequence_steps").select("*").eq("sequence_id",t.sequence_id).eq("step_index",t.current_step_index).eq("active",!0).limit(1),i=s?.[0];if(!i){await e.from("lead_sequences").update({completed:!0}).eq("id",t.id);continue}try{let r=i.rules||null;if(r&&"object"==typeof r){let n=r.action,s=Array.isArray(r.conditions)?r.conditions:[],o=0===s.length;for(let r of s)if(r?.type==="inbound_reply_within"){let n=Number(r.minutes||0),a=new Date(Date.now()-6e4*n).toISOString(),{data:s}=await e.from("messages").select("*").eq("lead_id",t.lead_id).eq("direction","inbound").gte("created_at",a).limit(1);o=o||!!(s&&s.length>0)}else if(r?.type==="lead_opted_out")o=o||!!a?.is_opted_out;else if(r?.type==="pipeline_status_in"){let e=Array.isArray(r.statuses)?r.statuses:[];o=o||e.includes(a?.pipeline_status)}else if(r?.type==="sentiment_high"){let{data:r}=await e.from("call_summaries").select("*").eq("lead_id",t.lead_id).order("created_at",{ascending:!1}).limit(1);o=o||r?.[0]?.sentiment==="positive"}if(n&&o){if(await e.from("lead_sequence_steps").insert({lead_sequence_id:t.id,step_index:i.step_index,status:"rule_action",metadata:{action:n,rules:r}}),"skip"===n){let r=t.current_step_index+1,{data:n}=await e.from("sequence_steps").select("*").eq("sequence_id",t.sequence_id).eq("active",!0),a=(n||[]).find(e=>e.step_index===r),s=a?.delay_minutes||0,i=new Date(Date.now()+6e4*s).toISOString();await e.from("lead_sequences").update({current_step_index:r,next_run_at:i}).eq("id",t.id);continue}if("pause"===n){let n=Number(r.pause_minutes||60),a=new Date(Date.now()+6e4*n).toISOString();await e.from("lead_sequences").update({next_run_at:a}).eq("id",t.id);continue}if("jump"===n){let n=Number(r.jump_to_step_index??t.current_step_index);await e.from("lead_sequences").update({current_step_index:n,next_run_at:new Date().toISOString()}).eq("id",t.id);continue}else if("complete"===n){await e.from("lead_sequences").update({completed:!0}).eq("id",t.id);continue}}}}catch{}let o=!1;try{let r=new Date(Date.now()-6e4*Number(process.env.SEQUENCE_REPLY_PAUSE_MINUTES||720)).toISOString(),{data:n}=await e.from("messages").select("*").eq("lead_id",t.lead_id).eq("direction","inbound").gte("created_at",r).limit(1);o=!!(n&&n.length>0)}catch{}if(o&&"sms"===i.type){await e.from("lead_sequence_steps").insert({lead_sequence_id:t.id,step_index:i.step_index,status:"skipped",metadata:{reason:"recent_inbound"}});let{data:r}=await e.from("sequence_steps").select("*").eq("sequence_id",t.sequence_id).eq("active",!0),n=t.current_step_index+1,a=(r||[]).find(e=>e.step_index===n),s=a?.delay_minutes||0,o=new Date(Date.now()+6e4*s).toISOString();await e.from("lead_sequences").update({current_step_index:n,next_run_at:o,retry_count:0}).eq("id",t.id);continue}let l="pending",d={};try{if("sms"===i.type)if(r){let e=await (0,q.sendSMS)(a.phone_number,i.message||"");l=e.error?"error":"sent",d={sid:e.sid,error:e.error||null,message:i.message||""}}else l="not_configured",d={error:"SMS not configured"};else if("voicemail"===i.type)if(n){let e=(0,q.getTwilioClient)();if(!e)throw Error("Twilio missing");let t=await (0,q.eligibleNumbersSorted)(),r=(0,q.chooseCallerId)()||t[0];if(!r)throw Error("No caller ID configured");let n=`http://localhost:3000/api/twilio/sequences/voicemail?recording_url=${encodeURIComponent(i.recording_url||"")}`,s=await e.calls.create({to:a.phone_number,from:r,url:n,machineDetection:"Enable"});l="queued",d={call_sid:s.sid}}else l="not_configured",d={error:"Voicemail not configured"}}catch(e){l="error",d={error:e?.message||"send failed"}}if(await e.from("lead_sequence_steps").insert({lead_sequence_id:t.id,step_index:i.step_index,status:l,metadata:d}),"not_configured"===l){let r=new Date(Date.now()+36e5).toISOString();await e.from("lead_sequences").update({next_run_at:r}).eq("id",t.id);continue}if("error"===l){let r=Number(process.env.SEQUENCE_RETRY_BASE_MINUTES||5),n=Number(t.retry_count||0),a="sms"===i.type?2:1,s=n+1,o=r*Math.pow(2,n),l=new Date(Date.now()+6e4*o).toISOString(),d=Number(t.fail_streak||0)+1;if(s<=a){await e.from("lead_sequences").update({retry_count:s,fail_streak:d,next_run_at:l}).eq("id",t.id);continue}if(d>=5){await e.from("lead_sequences").update({completed:!0,disabled:!0}).eq("id",t.id);continue}await e.from("lead_sequences").update({retry_count:0,fail_streak:d}).eq("id",t.id)}else await e.from("lead_sequences").update({retry_count:0,fail_streak:0}).eq("id",t.id);let{data:u}=await e.from("sequence_steps").select("*").eq("sequence_id",t.sequence_id).eq("active",!0),c=Math.max(...(u||[]).map(e=>e.step_index),0);if(t.current_step_index>=c)await e.from("lead_sequences").update({completed:!0}).eq("id",t.id);else{let r=t.current_step_index+1,n=(u||[]).find(e=>e.step_index===r),a=n?.delay_minutes||0,s=new Date(Date.now()+6e4*a).toISOString();await e.from("lead_sequences").update({current_step_index:r,next_run_at:s}).eq("id",t.id)}}}async function I(){try{return await S(),x.NextResponse.json({success:!0})}catch(e){return x.NextResponse.json({error:e?.message||"Runner failed"},{status:500})}}async function R(){return await S(),x.NextResponse.json({success:!0})}e.s(["GET",()=>I,"default",()=>R,"runOnce",()=>S,"runtime",0,"nodejs","schedule",0,"*/1 * * * *"],97630);var y=e.i(97630);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/sequences/runner/route",pathname:"/api/sequences/runner",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/sequences/runner/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:b}=E;function C(){return(0,n.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}async function N(e,t,n){E.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/sequences/runner/route";x=x.replace(/\/index$/,"")||"/";let v=await E.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:q,params:S,nextConfig:I,parsedUrl:R,isDraftMode:y,prerenderManifest:O,routerServerContext:T,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,resolvedPathname:N,clientReferenceManifest:M,serverActionsManifest:A}=v,D=(0,l.normalizeAppPath)(x),U=!!(O.dynamicRoutes[D]||O.routes[N]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,R,!1):t.end("This page could not be found"),null);if(U&&!y){let e=!!O.routes[N],t=O.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await P();throw new w.NoFallbackError}}let k=null;!U||E.isDev||y||(k="/index"===(k=N)?"/":k);let L=!0===E.isDev||!U,H=U&&!L;A&&M&&(0,i.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:M,serverActionsManifest:A,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:A})});let j=e.method||"GET",$=(0,s.getTracer)(),W=$.getActiveScopeSpan(),F={params:S,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>E.onRequestError(e,t,n,T)},sharedContext:{buildId:q}},B=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),Y=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let i=async e=>E.handle(Y,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${x}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&b&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!U)return await (0,_.sendResponse)(B,K,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})},T),t}},u=await E.handleResponse({req:e,nextConfig:I,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!U)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&U||c.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,_.sendResponse)(B,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};W?await l(W):await $.withPropagatedContext(e.headers,()=>$.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${x}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})}),U)throw t;return await (0,_.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>C,"routeModule",()=>E,"serverHooks",()=>b,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>T],81613)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__fea4c8db._.js.map