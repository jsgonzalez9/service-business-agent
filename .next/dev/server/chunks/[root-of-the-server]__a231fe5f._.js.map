{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/hector/.openclaw/workspace/svc-agent/app/api/setup/run-migrations/route.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\nimport { NextResponse } from \"next/server\"\nimport fs from \"fs\"\nimport path from \"path\"\n\nexport async function POST() {\n  try {\n    const cookieStore = await cookies()\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\"\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || \"\"\n\n    if (!supabaseUrl || !supabaseServiceKey) {\n      return NextResponse.json({ success: false, error: \"Missing Supabase credentials\" }, { status: 400 })\n    }\n\n    const supabase = createServerClient(supabaseUrl, supabaseServiceKey, {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll() {},\n      },\n    })\n\n    const sqlFiles = [\n      \"001_create_leads_table.sql\",\n      \"002_create_messages_table.sql\",\n      \"003_create_agent_config_table.sql\",\n      \"004_add_model_tracking.sql\",\n      \"005_create_call_tracking.sql\",\n      \"006_create_followup_sequences.sql\",\n      \"007_create_sms_events.sql\",\n      \"008_alter_leads_optout.sql\",\n      \"009_create_a2p_tables.sql\",\n      \"010_alter_followup_queue.sql\",\n      \"011_alter_agent_config_followup.sql\",\n      \"012_alter_leads_mortgage.sql\",\n      \"013_create_conversation_summaries.sql\",\n      \"014_create_property_photos.sql\",\n      \"015_alter_followup_reason_next.sql\",\n      \"016_create_consents.sql\",\n      \"017_alter_leads_consent.sql\",\n      \"018_create_call_summaries.sql\",\n      \"019_alter_call_summaries_details.sql\",\n      \"020_create_sequences.sql\",\n      \"021_alter_lead_sequences_retry.sql\",\n      \"024_create_sequence_runs.sql\",\n      \"025_create_contracts.sql\",\n      \"026_alter_leads_state.sql\",\n      \"027_create_cached_responses.sql\",\n      \"027b_create_cached_responses_json.sql\",\n      \"027c_alter_cached_responses_intent.sql\",\n      \"028_alter_leads_state_machine.sql\",\n      \"029_buyers.sql\",\n      \"030_alter_cached_responses_embeddings.sql\",\n      \"031_alter_agent_config_llm_cache.sql\",\n      \"032_alter_agent_config_llm_cache_policy.sql\",\n      \"033_alter_agent_config_market_overrides.sql\",\n      \"034_alter_leads_dispo_fields.sql\",\n      \"035_alter_agent_config_auto_dispo.sql\",\n      \"036_create_buyer_broadcasts.sql\",\n      \"037_create_buyer_offers.sql\",\n      \"038_alter_leads_assignment.sql\",\n      \"039_alter_leads_add_state.sql\",\n      \"040_alter_leads_dispo_review.sql\",\n      \"041_alter_leads_buyer_contract.sql\",\n      \"042_alter_contract_templates_docuseal.sql\",\n      \"043_alter_contract_templates_direct_link.sql\",\n    ]\n\n    const executed: Record<string, boolean> = {}\n\n    for (const file of sqlFiles) {\n      const filePath = path.join(process.cwd(), \"scripts\", file)\n      if (!fs.existsSync(filePath)) {\n        console.error(`[v0] SQL file not found: ${filePath}`)\n        executed[file] = false\n        continue\n      }\n\n      const sql = fs.readFileSync(filePath, \"utf-8\")\n\n      try {\n        const { error } = await supabase.rpc(\"exec\", {\n          sql_query: sql,\n        })\n\n        if (error) {\n          console.error(`[v0] Error executing ${file}:`, error)\n          executed[file] = false\n        } else {\n          executed[file] = true\n        }\n      } catch (err) {\n        console.error(`[v0] Exception executing ${file}:`, err)\n        executed[file] = false\n      }\n    }\n\n    return NextResponse.json({ success: true, executed })\n  } catch (error) {\n    console.error(\"[v0] Migration error:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to run migrations\", executed: {} }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,cAAc,8DAAwC;QAC5D,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB,IAAI;QAEpE,IAAI,CAAC,eAAe,CAAC,oBAAoB;YACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAA+B,GAAG;gBAAE,QAAQ;YAAI;QACpG;QAEA,MAAM,WAAW,IAAA,iMAAkB,EAAC,aAAa,oBAAoB;YACnE,SAAS;gBACP;oBACE,OAAO,YAAY,MAAM;gBAC3B;gBACA,WAAU;YACZ;QACF;QAEA,MAAM,WAAW;YACf;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,MAAM,WAAoC,CAAC;QAE3C,KAAK,MAAM,QAAQ,SAAU;YAC3B,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,WAAW;YACrD,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;gBAC5B,QAAQ,KAAK,CAAC,CAAC,yBAAyB,EAAE,UAAU;gBACpD,QAAQ,CAAC,KAAK,GAAG;gBACjB;YACF;YAEA,MAAM,MAAM,wGAAE,CAAC,YAAY,CAAC,UAAU;YAEtC,IAAI;gBACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,QAAQ;oBAC3C,WAAW;gBACb;gBAEA,IAAI,OAAO;oBACT,QAAQ,KAAK,CAAC,CAAC,qBAAqB,EAAE,KAAK,CAAC,CAAC,EAAE;oBAC/C,QAAQ,CAAC,KAAK,GAAG;gBACnB,OAAO;oBACL,QAAQ,CAAC,KAAK,GAAG;gBACnB;YACF,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC,CAAC,yBAAyB,EAAE,KAAK,CAAC,CAAC,EAAE;gBACnD,QAAQ,CAAC,KAAK,GAAG;YACnB;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAS;IACrD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;YAA4B,UAAU,CAAC;QAAE,GAAG;YAAE,QAAQ;QAAI;IAC9G;AACF"}}]
}